<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贷款利息计算器 - 在线房贷计算器 | 等额本息、等额本金计算</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="免费在线贷款利息计算器，支持等额本息、等额本金两种还款方式。可计算商业贷款、公积金贷款和组合贷款，提供详细还款计划表，帮助您合理规划房贷。">
    <meta name="keywords" content="贷款计算器,房贷计算器,利息计算,等额本息,等额本金,公积金贷款,商业贷款,还款计划表">
    <meta name="author" content="多功能工具箱">
    <meta name="robots" content="index, follow">
    <meta name="language" content="zh-CN">
    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.seekpie.com/tools/loan-calculator.html">
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "贷款利息计算器",
      "description": "免费在线贷款利息计算器，支持等额本息、等额本金计算和组合贷款",
      "url": "https://www.seekpie.com/tools/loan-calculator.html",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "All",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "CNY"
      },
      "featureList": [
        "等额本息计算",
        "等额本金计算",
        "商业贷款计算",
        "公积金贷款计算",
        "组合贷款计算",
        "详细还款计划表"
      ]
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: clamp(10px, 2vw, 20px);
            font-size: clamp(14px, 1.5vw, 16px);
        }

        .container {
            max-width: min(1400px, 70vw);
            margin: 0 auto;
            background: white;
            border-radius: clamp(12px, 2vw, 15px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: clamp(20px, 4vw, 30px);
            text-align: center;
        }

        .header h1 {
            font-size: clamp(1.5em, 3.5vw, 2.5em);
            margin-bottom: clamp(8px, 1.5vw, 10px);
            font-weight: 300;
        }

        .header p {
            font-size: clamp(0.9em, 2vw, 1.1em);
            opacity: 0.9;
        }

        .loan-type-section {
            background: #e8f4fd;
            border: 2px solid #4facfe;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .loan-type-tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .loan-type-tab {
            flex: 1;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-bottom: none;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .loan-type-tab:first-child {
            border-radius: 8px 0 0 0;
        }

        .loan-type-tab:last-child {
            border-radius: 0 8px 0 0;
        }

        .loan-type-tab.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .loan-type-content {
            display: none;
        }

        .loan-type-content.active {
            display: block;
        }

        .combination-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .combination-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #e1e5e9;
        }

        .combination-section h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .combination-section .input-group {
            margin-bottom: 15px;
        }


        .content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .input-group input, .input-group select {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .calculate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .results-section {
            margin-top: 30px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .summary-card h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .amount {
            font-size: 1.8em;
            font-weight: bold;
        }

        .summary-card .breakdown-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.85em;
            opacity: 0.8;
        }

        .summary-card .breakdown-info .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .summary-card .breakdown-info .breakdown-item:last-child {
            margin-bottom: 0;
        }

        .summary-card .breakdown-info .breakdown-label {
            font-weight: 500;
        }

        .summary-card .breakdown-info .breakdown-value {
            font-weight: bold;
        }

        .payment-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .table-header h3 {
            color: #333;
            font-size: 1.3em;
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #e1e5e9;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .history-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-header h3 {
            color: #333;
            font-size: 1.3em;
        }

        .history-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .history-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .history-btn.danger {
            background: #dc3545;
        }

        .history-btn.danger:hover {
            background: #c82333;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: #4facfe;
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.1);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delete-history-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .delete-history-btn:hover {
            background: #c82333;
            opacity: 1;
            transform: scale(1.05);
        }

        .history-item-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .history-item-date {
            color: #666;
            font-size: 0.9em;
        }

        .history-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.9em;
            color: #555;
        }

        .history-modal .history-item-details {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 15px;
            padding: 5px 0;
        }

        .history-modal .history-item-detail {
            flex-shrink: 0;
            min-width: 120px;
        }

        .history-item-detail {
            display: flex;
            flex-direction: column;
        }

        .history-item-detail-label {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .history-item-detail-value {
            color: #333;
            font-weight: 600;
        }

        .history-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .history-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .history-modal-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .history-modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .empty-history {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-history i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* 平板和中等屏幕 */
        @media (max-width: 1024px) {
            .content {
                padding: 30px;
            }

            .input-section {
                padding: 25px;
            }

            .history-section {
                padding: 25px;
            }
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                max-width: 100%;
                border-radius: 12px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 0.95em;
            }

            .content {
                padding: 20px 15px;
            }

            .loan-type-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .loan-type-tabs {
                margin-bottom: 15px;
                flex-wrap: wrap;
            }

            .loan-type-tab {
                padding: 10px 15px;
                font-size: 0.95em;
            }

            .loan-type-tab:first-child {
                border-radius: 8px 8px 0 0;
            }

            .loan-type-tab:last-child {
                border-radius: 0 0 8px 8px;
            }

            .input-section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .input-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .combination-inputs {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .combination-section {
                padding: 15px;
            }

            .combination-section h4 {
                font-size: 1em;
                margin-bottom: 12px;
            }

            .input-group label {
                font-size: 1em;
                margin-bottom: 6px;
            }

            .input-group input, .input-group select {
                padding: 10px 12px;
                font-size: 0.95em;
            }

            .calculate-btn {
                padding: 12px 30px;
                font-size: 1.1em;
                margin: 15px auto;
                width: 100%;
            }

            .history-section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .history-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                margin-bottom: 15px;
            }

            .history-header h3 {
                font-size: 1.2em;
                text-align: center;
            }

            .history-header div {
                display: flex;
                justify-content: center;
                gap: 10px;
            }

            .history-btn {
                padding: 8px 15px;
                font-size: 0.9em;
                flex: 1;
                max-width: 150px;
            }

            .history-list {
                max-height: 350px;
            }

            .history-item {
                padding: 12px;
                margin-bottom: 8px;
            }

            .history-item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .history-item-title {
                font-size: 1em;
            }

            .history-item-actions {
                width: 100%;
                justify-content: space-between;
            }

            .history-item-date {
                font-size: 0.85em;
            }

            .delete-history-btn {
                font-size: 0.8em;
                padding: 4px 10px;
            }

            .history-item-details {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                font-size: 0.85em;
            }

            .results-section {
                margin-top: 20px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }

            .summary-card {
                padding: 20px;
            }

            .summary-card h3 {
                font-size: 1em;
                margin-bottom: 8px;
            }

            .summary-card .amount {
                font-size: 1.5em;
            }

            .summary-card .breakdown-info {
                margin-top: 12px;
                padding-top: 12px;
                font-size: 0.8em;
            }

            .payment-table {
                border-radius: 8px;
            }

            .table-header {
                padding: 15px;
            }

            .table-header h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
            
            .table-container {
                font-size: 0.85em;
                max-height: 400px;
            }

            th, td {
                padding: 10px 8px;
                font-size: 0.9em;
            }

            .export-btn {
                padding: 8px 15px;
                margin: 5px 3px;
                font-size: 0.9em;
            }

            .history-modal-content {
                width: 95%;
                margin: 10% auto;
                max-height: 75vh;
            }

            .history-modal-header {
                padding: 15px;
            }

            .history-modal-header h3 {
                font-size: 1.1em;
            }

            .history-modal-body {
                padding: 15px;
                max-height: 55vh;
            }
        }

        /* 小屏手机优化 */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container {
                border-radius: 10px;
            }

            .header {
                padding: 15px 12px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.9em;
            }

            .content {
                padding: 15px 12px;
            }

            .loan-type-section {
                padding: 12px;
            }

            .loan-type-tab {
                padding: 8px 12px;
                font-size: 0.9em;
            }

            .input-section {
                padding: 15px 12px;
            }

            .combination-section {
                padding: 12px;
            }

            .combination-section h4 {
                font-size: 0.95em;
            }

            .input-group label {
                font-size: 0.95em;
            }

            .input-group input, .input-group select {
                padding: 8px 10px;
                font-size: 0.9em;
            }

            .calculate-btn {
                padding: 10px 25px;
                font-size: 1em;
            }

            .history-section {
                padding: 15px 12px;
            }

            .history-header h3 {
                font-size: 1.1em;
            }

            .history-btn {
                padding: 6px 12px;
                font-size: 0.85em;
            }

            .history-item {
                padding: 10px;
            }

            .history-item-title {
                font-size: 0.95em;
            }

            .history-item-details {
                grid-template-columns: 1fr;
                gap: 6px;
                font-size: 0.8em;
            }

            .summary-card {
                padding: 15px;
            }

            .summary-card h3 {
                font-size: 0.95em;
            }

            .summary-card .amount {
                font-size: 1.3em;
            }

            .summary-card .breakdown-info {
                font-size: 0.75em;
            }

            .table-header {
                padding: 12px;
            }

            .table-header h3 {
                font-size: 1em;
            }

            .table-container {
                font-size: 0.8em;
                max-height: 350px;
            }

            th, td {
                padding: 8px 5px;
                font-size: 0.85em;
            }

            .export-btn {
                padding: 6px 12px;
                font-size: 0.85em;
                display: block;
                width: 100%;
                margin: 5px 0;
            }

            .history-modal-content {
                width: 98%;
                margin: 15% auto;
            }

            .history-modal-header {
                padding: 12px;
            }

            .history-modal-header h3 {
                font-size: 1em;
            }

            .history-modal-body {
                padding: 12px;
            }

            .close-btn {
                font-size: 1.3em;
                width: 25px;
                height: 25px;
            }
        }

        /* 超小屏手机 */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.3em;
            }

            .header p {
                font-size: 0.85em;
            }

            .loan-type-tab {
                font-size: 0.85em;
            }

            .summary-card .amount {
                font-size: 1.2em;
            }

            .table-container {
                font-size: 0.75em;
            }

            th, td {
                padding: 6px 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏦 贷款利息计算工具</h1>
            <p>专业的贷款计算器，支持商贷和组合贷，支持等额本息和等额本金两种还款方式</p>
        </div>

        <div class="content">
            <div class="loan-type-section">
                <div class="loan-type-tabs">
                    <div class="loan-type-tab active" onclick="switchLoanType('single')">单一贷款</div>
                    <div class="loan-type-tab" onclick="switchLoanType('combination')">组合贷款</div>
                </div>
                
                <div class="loan-type-content active" id="single-loan">
                    <div class="input-section">
                        <div class="input-grid">
                            <div class="input-group">
                                <label for="loanAmount">贷款额度 (元)</label>
                                <input type="number" id="loanAmount" placeholder="请输入贷款金额" min="0" step="0.01">
                            </div>
                            <div class="input-group">
                                <label for="interestRate">年利率 (%)</label>
                                <input type="number" id="interestRate" placeholder="请输入年利率" min="0" step="0.01">
                            </div>
                            <div class="input-group">
                                <label for="loanTerm">贷款期限 (月)</label>
                                <input type="number" id="loanTerm" placeholder="请输入贷款期限" min="1" max="50">
                            </div>
                            <div class="input-group">
                                <label for="paymentMethod">还款方式</label>
                                <select id="paymentMethod">
                                    <option value="equal_payment">等额本息</option>
                                    <option value="equal_principal">等额本金</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="startDate">开始还款日期</label>
                                <input type="date" id="startDate">
                            </div>
                        </div>
                        <button class="calculate-btn" onclick="calculateLoan()">计算贷款</button>
                    </div>
                </div>

                <div class="loan-type-content" id="combination-loan">
                    <div class="input-section">
                        <div class="combination-inputs">
                            <div class="combination-section">
                                <h4>🏦 商业贷款</h4>
                                <div class="input-group">
                                    <label for="commercialAmount">商贷额度 (元)</label>
                                    <input type="number" id="commercialAmount" placeholder="请输入商贷金额" min="0" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label for="commercialRate">商贷年利率 (%)</label>
                                    <input type="number" id="commercialRate" placeholder="请输入商贷利率" min="0" step="0.01">
                                </div>
                            </div>
                            
                            <div class="combination-section">
                                <h4>🏠 公积金贷款</h4>
                                <div class="input-group">
                                    <label for="providentAmount">公积金贷额度 (元)</label>
                                    <input type="number" id="providentAmount" placeholder="请输入公积金贷金额" min="0" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label for="providentRate">公积金贷年利率 (%)</label>
                                    <input type="number" id="providentRate" placeholder="请输入公积金贷利率" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-grid">
                            <div class="input-group">
                                <label for="combinationTerm">贷款期限 (月)</label>
                                <input type="number" id="combinationTerm" placeholder="请输入贷款期限" min="1" max="50">
                            </div>
                            <div class="input-group">
                                <label for="combinationMethod">还款方式</label>
                                <select id="combinationMethod">
                                    <option value="equal_payment">等额本息</option>
                                    <option value="equal_principal">等额本金</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="combinationStartDate">开始还款日期</label>
                                <input type="date" id="combinationStartDate">
                            </div>
                        </div>
                        <button class="calculate-btn" onclick="calculateCombinationLoan()">计算组合贷款</button>
                    </div>
                </div>
            </div>

            <div class="history-section">
                <div class="history-header">
                    <h3>📊 计算历史</h3>
                    <div>
                        <button class="history-btn" onclick="showHistoryModal()">查看全部</button>
                        <button class="history-btn danger" onclick="clearAllHistory()">清空历史</button>
                    </div>
                </div>
                <div class="history-list" id="historyList">
                    <div class="empty-history">
                        <div>📝</div>
                        <p>暂无计算历史</p>
                    </div>
                </div>
            </div>

            <div class="results-section" id="resultsSection" style="display: none;">
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>总还款额</h3>
                        <div class="amount" id="totalPayment">¥0</div>
                        <div class="breakdown-info" id="totalPaymentBreakdown" style="display: none;">
                            <div class="breakdown-item">
                                <span class="breakdown-label">商贷部分:</span>
                                <span class="breakdown-value" id="commercialTotalPayment">¥0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">公积金贷部分:</span>
                                <span class="breakdown-value" id="providentTotalPayment">¥0</span>
                            </div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <h3>总利息</h3>
                        <div class="amount" id="totalInterest">¥0</div>
                        <div class="breakdown-info" id="totalInterestBreakdown" style="display: none;">
                            <div class="breakdown-item">
                                <span class="breakdown-label">商贷部分:</span>
                                <span class="breakdown-value" id="commercialTotalInterest">¥0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">公积金贷部分:</span>
                                <span class="breakdown-value" id="providentTotalInterest">¥0</span>
                            </div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <h3>月均还款</h3>
                        <div class="amount" id="avgMonthlyPayment">¥0</div>
                        <div class="breakdown-info" id="avgMonthlyPaymentBreakdown" style="display: none;">
                            <div class="breakdown-item">
                                <span class="breakdown-label">商贷部分:</span>
                                <span class="breakdown-value" id="commercialAvgMonthlyPayment">¥0</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">公积金贷部分:</span>
                                <span class="breakdown-value" id="providentAvgMonthlyPayment">¥0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="payment-table">
                    <div class="table-header">
                        <h3>还款计划表</h3>
                        <button class="export-btn" onclick="exportToCSV()">导出CSV</button>
                        <button class="export-btn" onclick="printTable()">打印表格</button>
                    </div>
                    <div class="table-container">
                        <table id="paymentTable">
                            <thead>
                                <tr>
                                    <th>期数</th>
                                    <th>还款日期</th>
                                    <th>月还款额</th>
                                    <th>本金</th>
                                    <th>利息</th>
                                    <th>剩余本金</th>
                                    <th id="commercialColumn" style="display: none;">商贷还款</th>
                                    <th id="providentColumn" style="display: none;">公积金贷还款</th>
                                    <th id="commercialRemainingColumn" style="display: none;">商贷剩余本金</th>
                                    <th id="providentRemainingColumn" style="display: none;">公积金贷剩余本金</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 历史记录模态框 -->
    <div id="historyModal" class="history-modal">
        <div class="history-modal-content">
            <div class="history-modal-header">
                <h3>📊 计算历史记录</h3>
                <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="history-modal-body" id="historyModalBody">
                <!-- 历史记录内容将在这里动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 历史记录管理
        const HISTORY_KEY = 'loan_calculation_history';
        const MAX_HISTORY_ITEMS = 20;
        let isLoadingFromHistory = false; // 标志位：是否正在从历史记录加载

        // 设置默认开始日期为下个月
        document.getElementById('startDate').value = getNextMonth();
        document.getElementById('combinationStartDate').value = getNextMonth();

        // 页面加载时显示历史记录
        window.addEventListener('load', function() {
            displayHistoryList();
        });

        function getNextMonth() {
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            return nextMonth.toISOString().split('T')[0];
        }

        function switchLoanType(type) {
            // 切换标签页样式
            document.querySelectorAll('.loan-type-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.loan-type-content').forEach(content => content.classList.remove('active'));
            
            if (type === 'single') {
                document.querySelector('.loan-type-tab:first-child').classList.add('active');
                document.getElementById('single-loan').classList.add('active');
            } else {
                document.querySelector('.loan-type-tab:last-child').classList.add('active');
                document.getElementById('combination-loan').classList.add('active');
            }
            
            // 隐藏结果区域
            document.getElementById('resultsSection').style.display = 'none';
        }

        function calculateLoan() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const loanTerm = parseInt(document.getElementById('loanTerm').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const startDate = new Date(document.getElementById('startDate').value);

            // 验证输入
            if (!loanAmount || !interestRate || !loanTerm || !startDate) {
                alert('请填写所有必填字段');
                return;
            }

            if (loanAmount <= 0 || interestRate < 0 || loanTerm <= 0) {
                alert('请输入有效的数值');
                return;
            }

            const monthlyRate = interestRate / 100 / 12;
            const totalMonths = loanTerm;
            let paymentSchedule = [];

            if (paymentMethod === 'equal_payment') {
                paymentSchedule = calculateEqualPayment(loanAmount, monthlyRate, totalMonths, startDate);
            } else {
                paymentSchedule = calculateEqualPrincipal(loanAmount, monthlyRate, totalMonths, startDate);
            }

            displayResults(paymentSchedule, false);
            
            // 只有在不是从历史记录加载时才保存到历史记录
            if (!isLoadingFromHistory) {
                saveToHistory({
                    isCombination: false,
                    loanAmount: loanAmount,
                    interestRate: interestRate,
                    loanTerm: loanTerm,
                    paymentMethod: paymentMethod,
                    startDate: document.getElementById('startDate').value,
                    result: paymentSchedule
                });
            }
        }

        function calculateCombinationLoan() {
            const commercialAmount = parseFloat(document.getElementById('commercialAmount').value) || 0;
            const commercialRate = parseFloat(document.getElementById('commercialRate').value) || 0;
            const providentAmount = parseFloat(document.getElementById('providentAmount').value) || 0;
            const providentRate = parseFloat(document.getElementById('providentRate').value) || 0;
            const loanTerm = parseInt(document.getElementById('combinationTerm').value);
            const paymentMethod = document.getElementById('combinationMethod').value;
            const startDate = new Date(document.getElementById('combinationStartDate').value);

            // 验证输入
            if (!loanTerm || !startDate) {
                alert('请填写贷款期限和开始日期');
                return;
            }

            if (commercialAmount <= 0 && providentAmount <= 0) {
                alert('请至少填写一种贷款的金额');
                return;
            }

            if (loanTerm <= 0) {
                alert('请输入有效的贷款期限');
                return;
            }

            const totalMonths = loanTerm;
            let commercialResult = null;
            let providentResult = null;

            // 计算商贷
            if (commercialAmount > 0 && commercialRate >= 0) {
                const commercialMonthlyRate = commercialRate / 100 / 12;
                if (paymentMethod === 'equal_payment') {
                    commercialResult = calculateEqualPayment(commercialAmount, commercialMonthlyRate, totalMonths, startDate);
                } else {
                    commercialResult = calculateEqualPrincipal(commercialAmount, commercialMonthlyRate, totalMonths, startDate);
                }
            }

            // 计算公积金贷
            if (providentAmount > 0 && providentRate >= 0) {
                const providentMonthlyRate = providentRate / 100 / 12;
                if (paymentMethod === 'equal_payment') {
                    providentResult = calculateEqualPayment(providentAmount, providentMonthlyRate, totalMonths, startDate);
                } else {
                    providentResult = calculateEqualPrincipal(providentAmount, providentMonthlyRate, totalMonths, startDate);
                }
            }

            // 合并结果
            const combinationResult = combineLoanResults(commercialResult, providentResult, totalMonths, startDate);
            displayResults(combinationResult, true);
            
            // 只有在不是从历史记录加载时才保存到历史记录
            if (!isLoadingFromHistory) {
                saveToHistory({
                    isCombination: true,
                    commercialAmount: commercialAmount,
                    commercialRate: commercialRate,
                    providentAmount: providentAmount,
                    providentRate: providentRate,
                    loanTerm: loanTerm,
                    paymentMethod: paymentMethod,
                    startDate: document.getElementById('combinationStartDate').value,
                    result: combinationResult
                });
            }
        }

        function combineLoanResults(commercialResult, providentResult, totalMonths, startDate) {
            const schedule = [];
            let totalPayment = 0;
            let totalInterest = 0;
            let commercialTotalPayment = 0;
            let commercialTotalInterest = 0;
            let providentTotalPayment = 0;
            let providentTotalInterest = 0;

            for (let i = 0; i < totalMonths; i++) {
                const paymentDate = new Date(startDate);
                paymentDate.setMonth(paymentDate.getMonth() + i);

                let monthlyPayment = 0;
                let principalPayment = 0;
                let interestPayment = 0;
                let remainingPrincipal = 0;
                let commercialPayment = 0;
                let providentPayment = 0;
                let commercialRemainingPrincipal = 0;
                let providentRemainingPrincipal = 0;

                if (commercialResult) {
                    const commercialPaymentData = commercialResult.schedule[i];
                    monthlyPayment += commercialPaymentData.monthlyPayment;
                    principalPayment += commercialPaymentData.principalPayment;
                    interestPayment += commercialPaymentData.interestPayment;
                    remainingPrincipal += commercialPaymentData.remainingPrincipal;
                    commercialPayment = commercialPaymentData.monthlyPayment;
                    commercialRemainingPrincipal = commercialPaymentData.remainingPrincipal;
                    commercialTotalPayment += commercialPaymentData.monthlyPayment;
                    commercialTotalInterest += commercialPaymentData.interestPayment;
                }

                if (providentResult) {
                    const providentPaymentData = providentResult.schedule[i];
                    monthlyPayment += providentPaymentData.monthlyPayment;
                    principalPayment += providentPaymentData.principalPayment;
                    interestPayment += providentPaymentData.interestPayment;
                    remainingPrincipal += providentPaymentData.remainingPrincipal;
                    providentPayment = providentPaymentData.monthlyPayment;
                    providentRemainingPrincipal = providentPaymentData.remainingPrincipal;
                    providentTotalPayment += providentPaymentData.monthlyPayment;
                    providentTotalInterest += providentPaymentData.interestPayment;
                }

                totalPayment += monthlyPayment;
                totalInterest += interestPayment;

                schedule.push({
                    period: i + 1,
                    date: formatDate(paymentDate),
                    monthlyPayment: monthlyPayment,
                    principalPayment: principalPayment,
                    interestPayment: interestPayment,
                    remainingPrincipal: remainingPrincipal,
                    commercialPayment: commercialPayment,
                    providentPayment: providentPayment,
                    commercialRemainingPrincipal: commercialRemainingPrincipal,
                    providentRemainingPrincipal: providentRemainingPrincipal
                });
            }

            return {
                schedule: schedule,
                totalPayment: totalPayment,
                totalInterest: totalInterest,
                avgMonthlyPayment: totalPayment / totalMonths,
                commercialTotalPayment: commercialTotalPayment,
                commercialTotalInterest: commercialTotalInterest,
                providentTotalPayment: providentTotalPayment,
                providentTotalInterest: providentTotalInterest
            };
        }

        function calculateEqualPayment(principal, monthlyRate, totalMonths, startDate) {
            const monthlyPayment = principal * monthlyRate * Math.pow(1 + monthlyRate, totalMonths) / 
                                 (Math.pow(1 + monthlyRate, totalMonths) - 1);
            
            const schedule = [];
            let remainingPrincipal = principal;
            let totalInterest = 0;

            for (let i = 0; i < totalMonths; i++) {
                const interestPayment = remainingPrincipal * monthlyRate;
                const principalPayment = monthlyPayment - interestPayment;
                remainingPrincipal -= principalPayment;
                totalInterest += interestPayment;

                const paymentDate = new Date(startDate);
                paymentDate.setMonth(paymentDate.getMonth() + i);

                schedule.push({
                    period: i + 1,
                    date: formatDate(paymentDate),
                    monthlyPayment: monthlyPayment,
                    principalPayment: principalPayment,
                    interestPayment: interestPayment,
                    remainingPrincipal: Math.max(0, remainingPrincipal)
                });
            }

            return {
                schedule: schedule,
                totalPayment: principal + totalInterest,
                totalInterest: totalInterest,
                avgMonthlyPayment: monthlyPayment
            };
        }

        function calculateEqualPrincipal(principal, monthlyRate, totalMonths, startDate) {
            const monthlyPrincipal = principal / totalMonths;
            const schedule = [];
            let remainingPrincipal = principal;
            let totalInterest = 0;

            for (let i = 0; i < totalMonths; i++) {
                const interestPayment = remainingPrincipal * monthlyRate;
                const monthlyPayment = monthlyPrincipal + interestPayment;
                remainingPrincipal -= monthlyPrincipal;
                totalInterest += interestPayment;

                const paymentDate = new Date(startDate);
                paymentDate.setMonth(paymentDate.getMonth() + i);

                schedule.push({
                    period: i + 1,
                    date: formatDate(paymentDate),
                    monthlyPayment: monthlyPayment,
                    principalPayment: monthlyPrincipal,
                    interestPayment: interestPayment,
                    remainingPrincipal: Math.max(0, remainingPrincipal)
                });
            }

            return {
                schedule: schedule,
                totalPayment: principal + totalInterest,
                totalInterest: totalInterest,
                avgMonthlyPayment: (principal + totalInterest) / totalMonths
            };
        }

        function formatDate(date) {
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0');
        }

        function formatCurrency(amount) {
            return '¥' + amount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function displayResults(result, isCombination = false) {
            // 显示结果区域
            document.getElementById('resultsSection').style.display = 'block';

            // 更新汇总信息 - 对于组合贷，显示合并后的总数据
            if (isCombination) {
                // 组合贷：显示合并后的总还款额和总利息
                document.getElementById('totalPayment').textContent = formatCurrency(result.totalPayment);
                document.getElementById('totalInterest').textContent = formatCurrency(result.totalInterest);
                document.getElementById('avgMonthlyPayment').textContent = formatCurrency(result.avgMonthlyPayment);
            } else {
                // 单一贷款：显示原始数据
                document.getElementById('totalPayment').textContent = formatCurrency(result.totalPayment);
                document.getElementById('totalInterest').textContent = formatCurrency(result.totalInterest);
                document.getElementById('avgMonthlyPayment').textContent = formatCurrency(result.avgMonthlyPayment);
            }

            // 显示或隐藏组合贷分解信息
            const totalPaymentBreakdown = document.getElementById('totalPaymentBreakdown');
            const totalInterestBreakdown = document.getElementById('totalInterestBreakdown');
            const avgMonthlyPaymentBreakdown = document.getElementById('avgMonthlyPaymentBreakdown');
            
            if (isCombination) {
                // 显示分解明细：商贷和公积金贷的详细数据
                totalPaymentBreakdown.style.display = 'block';
                totalInterestBreakdown.style.display = 'block';
                avgMonthlyPaymentBreakdown.style.display = 'block';
                
                document.getElementById('commercialTotalPayment').textContent = formatCurrency(result.commercialTotalPayment);
                document.getElementById('commercialTotalInterest').textContent = formatCurrency(result.commercialTotalInterest);
                document.getElementById('providentTotalPayment').textContent = formatCurrency(result.providentTotalPayment);
                document.getElementById('providentTotalInterest').textContent = formatCurrency(result.providentTotalInterest);
                
                // 计算月均还款分解
                const totalMonths = result.schedule.length;
                const commercialAvgMonthly = result.commercialTotalPayment / totalMonths;
                const providentAvgMonthly = result.providentTotalPayment / totalMonths;
                
                document.getElementById('commercialAvgMonthlyPayment').textContent = formatCurrency(commercialAvgMonthly);
                document.getElementById('providentAvgMonthlyPayment').textContent = formatCurrency(providentAvgMonthly);
            } else {
                totalPaymentBreakdown.style.display = 'none';
                totalInterestBreakdown.style.display = 'none';
                avgMonthlyPaymentBreakdown.style.display = 'none';
            }

            // 生成还款计划表
            const tableBody = document.getElementById('paymentTableBody');
            tableBody.innerHTML = '';

            // 显示或隐藏组合贷列
            const commercialColumn = document.getElementById('commercialColumn');
            const providentColumn = document.getElementById('providentColumn');
            const commercialRemainingColumn = document.getElementById('commercialRemainingColumn');
            const providentRemainingColumn = document.getElementById('providentRemainingColumn');
            if (isCombination) {
                commercialColumn.style.display = 'table-cell';
                providentColumn.style.display = 'table-cell';
                commercialRemainingColumn.style.display = 'table-cell';
                providentRemainingColumn.style.display = 'table-cell';
            } else {
                commercialColumn.style.display = 'none';
                providentColumn.style.display = 'none';
                commercialRemainingColumn.style.display = 'none';
                providentRemainingColumn.style.display = 'none';
            }

            result.schedule.forEach(payment => {
                const row = document.createElement('tr');
                let rowHTML = `
                    <td>${payment.period}</td>
                    <td>${payment.date}</td>
                    <td>${formatCurrency(payment.monthlyPayment)}</td>
                    <td>${formatCurrency(payment.principalPayment)}</td>
                    <td>${formatCurrency(payment.interestPayment)}</td>
                    <td>${formatCurrency(payment.remainingPrincipal)}</td>
                `;
                
                if (isCombination) {
                    rowHTML += `
                        <td>${formatCurrency(payment.commercialPayment)}</td>
                        <td>${formatCurrency(payment.providentPayment)}</td>
                        <td>${formatCurrency(payment.commercialRemainingPrincipal)}</td>
                        <td>${formatCurrency(payment.providentRemainingPrincipal)}</td>
                    `;
                }
                
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });

            // 滚动到结果区域
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function exportToCSV() {
            const table = document.getElementById('paymentTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            // 检查是否为组合贷
            const isCombination = document.getElementById('commercialColumn').style.display !== 'none';
            let csv = '期数,还款日期,月还款额,本金,利息,剩余本金';
            if (isCombination) {
                csv += ',商贷还款,公积金贷还款,商贷剩余本金,公积金贷剩余本金';
            }
            csv += '\n';
            
            rows.forEach((row, index) => {
                if (index === 0) return; // 跳过表头
                const cells = Array.from(row.querySelectorAll('td'));
                const rowData = cells.map(cell => cell.textContent.replace(/¥/g, '').replace(/,/g, ''));
                csv += rowData.join(',') + '\n';
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', isCombination ? '组合贷款还款计划表.csv' : '贷款还款计划表.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printTable() {
            const printWindow = window.open('', '_blank');
            const table = document.getElementById('paymentTable').outerHTML;
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>贷款还款计划表</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                            th { background-color: #f2f2f2; }
                        </style>
                    </head>
                    <body>
                        <h1>贷款还款计划表</h1>
                        ${table}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // 历史记录管理函数
        function saveToHistory(calculationData) {
            let history = getHistory();
            
            // 创建历史记录项
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: calculationData.isCombination ? '组合贷款' : '单一贷款',
                data: calculationData,
                summary: generateHistorySummary(calculationData)
            };
            
            // 添加到历史记录开头
            history.unshift(historyItem);
            
            // 限制历史记录数量
            if (history.length > MAX_HISTORY_ITEMS) {
                history = history.slice(0, MAX_HISTORY_ITEMS);
            }
            
            // 保存到localStorage
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            
            // 更新显示
            displayHistoryList();
        }

        function getHistory() {
            const historyStr = localStorage.getItem(HISTORY_KEY);
            return historyStr ? JSON.parse(historyStr) : [];
        }

        function generateHistorySummary(calculationData) {
            if (calculationData.isCombination) {
                return {
                    totalAmount: calculationData.result.totalPayment,
                    totalInterest: calculationData.result.totalInterest,
                    monthlyPayment: calculationData.result.avgMonthlyPayment,
                    commercialAmount: calculationData.result.commercialTotalPayment,
                    providentAmount: calculationData.result.providentTotalPayment,
                    term: calculationData.result.schedule.length
                };
            } else {
                return {
                    totalAmount: calculationData.result.totalPayment,
                    totalInterest: calculationData.result.totalInterest,
                    monthlyPayment: calculationData.result.avgMonthlyPayment,
                    term: calculationData.result.schedule.length
                };
            }
        }

        function displayHistoryList() {
            const history = getHistory();
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <div>📝</div>
                        <p>暂无计算历史</p>
                    </div>
                `;
                return;
            }
            
            // 只显示最近5条记录
            const recentHistory = history.slice(0, 5);
            
            historyList.innerHTML = recentHistory.map(item => `
                <div class="history-item">
                    <div class="history-item-header">
                        <div class="history-item-title" onclick="loadHistoryItem('${item.id}')" style="cursor: pointer;">${item.type}</div>
                        <div class="history-item-actions">
                            <div class="history-item-date">${formatHistoryDate(item.timestamp)}</div>
                            <button class="delete-history-btn" onclick="deleteHistoryItem('${item.id}', event)" title="删除此记录">删除</button>
                        </div>
                    </div>
                    <div class="history-item-details" onclick="loadHistoryItem('${item.id}')" style="cursor: pointer;">
                        <div class="history-item-detail">
                            <div class="history-item-detail-label">总还款额</div>
                            <div class="history-item-detail-value">${formatCurrency(item.summary.totalAmount)}</div>
                        </div>
                        <div class="history-item-detail">
                            <div class="history-item-detail-label">总利息</div>
                            <div class="history-item-detail-value">${formatCurrency(item.summary.totalInterest)}</div>
                        </div>
                        <div class="history-item-detail">
                            <div class="history-item-detail-label">月均还款</div>
                            <div class="history-item-detail-value">${formatCurrency(item.summary.monthlyPayment)}</div>
                        </div>
                        <div class="history-item-detail">
                            <div class="history-item-detail-label">贷款期限</div>
                            <div class="history-item-detail-value">${item.summary.term}月</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayHistoryModal() {
            const history = getHistory();
            const modalBody = document.getElementById('historyModalBody');
            
            if (history.length === 0) {
                modalBody.innerHTML = `
                    <div class="empty-history">
                        <div>📝</div>
                        <p>暂无计算历史</p>
                    </div>
                `;
            } else {
                modalBody.innerHTML = history.map(item => `
                    <div class="history-item">
                        <div class="history-item-header">
                            <div class="history-item-title" onclick="loadHistoryItem('${item.id}')" style="cursor: pointer;">${item.type}</div>
                            <div class="history-item-actions">
                                <div class="history-item-date">${formatHistoryDate(item.timestamp)}</div>
                                <button class="delete-history-btn" onclick="deleteHistoryItem('${item.id}', event)" title="删除此记录">删除</button>
                            </div>
                        </div>
                        <div class="history-item-details" onclick="loadHistoryItem('${item.id}')" style="cursor: pointer;">
                            <div class="history-item-detail">
                                <div class="history-item-detail-label">总还款额</div>
                                <div class="history-item-detail-value">${formatCurrency(item.summary.totalAmount)}</div>
                            </div>
                            <div class="history-item-detail">
                                <div class="history-item-detail-label">总利息</div>
                                <div class="history-item-detail-value">${formatCurrency(item.summary.totalInterest)}</div>
                            </div>
                            <div class="history-item-detail">
                                <div class="history-item-detail-label">月均还款</div>
                                <div class="history-item-detail-value">${formatCurrency(item.summary.monthlyPayment)}</div>
                            </div>
                            <div class="history-item-detail">
                                <div class="history-item-detail-label">贷款期限</div>
                                <div class="history-item-detail-value">${item.summary.term}月</div>
                            </div>
                            ${item.summary.commercialAmount ? `
                                <div class="history-item-detail">
                                    <div class="history-item-detail-label">商贷部分</div>
                                    <div class="history-item-detail-value">${formatCurrency(item.summary.commercialAmount)}</div>
                                </div>
                            ` : ''}
                            ${item.summary.providentAmount ? `
                                <div class="history-item-detail">
                                    <div class="history-item-detail-label">公积金贷部分</div>
                                    <div class="history-item-detail-value">${formatCurrency(item.summary.providentAmount)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        function formatHistoryDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function loadHistoryItem(id) {
            const history = getHistory();
            const item = history.find(h => h.id.toString() === id);
            
            if (!item) return;
            
            // 设置标志位，防止重复保存
            isLoadingFromHistory = true;
            
            // 加载历史记录到表单
            if (item.data.isCombination) {
                // 切换到组合贷款模式
                switchLoanType('combination');
                
                // 填充组合贷款数据
                document.getElementById('commercialAmount').value = item.data.commercialAmount || '';
                document.getElementById('commercialRate').value = item.data.commercialRate || '';
                document.getElementById('providentAmount').value = item.data.providentAmount || '';
                document.getElementById('providentRate').value = item.data.providentRate || '';
                document.getElementById('combinationTerm').value = item.data.loanTerm || '';
                document.getElementById('combinationMethod').value = item.data.paymentMethod || 'equal_payment';
                document.getElementById('combinationStartDate').value = item.data.startDate || '';
            } else {
                // 切换到单一贷款模式
                switchLoanType('single');
                
                // 填充单一贷款数据
                document.getElementById('loanAmount').value = item.data.loanAmount || '';
                document.getElementById('interestRate').value = item.data.interestRate || '';
                document.getElementById('loanTerm').value = item.data.loanTerm || '';
                document.getElementById('paymentMethod').value = item.data.paymentMethod || 'equal_payment';
                document.getElementById('startDate').value = item.data.startDate || '';
            }
            
            // 关闭模态框
            closeHistoryModal();
            
            // 自动计算
            if (item.data.isCombination) {
                calculateCombinationLoan();
            } else {
                calculateLoan();
            }
            
            // 重置标志位
            setTimeout(() => {
                isLoadingFromHistory = false;
            }, 100);
        }

        function showHistoryModal() {
            displayHistoryModal();
            document.getElementById('historyModal').style.display = 'block';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function deleteHistoryItem(id, event) {
            // 阻止事件冒泡，防止触发父元素的点击事件
            event.stopPropagation();
            
            if (confirm('确定要删除这条历史记录吗？此操作不可恢复。')) {
                let history = getHistory();
                history = history.filter(item => item.id.toString() !== id);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                
                // 更新显示
                displayHistoryList();
                displayHistoryModal(); // 如果模态框打开，也要更新
            }
        }

        function clearAllHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                localStorage.removeItem(HISTORY_KEY);
                displayHistoryList();
                closeHistoryModal();
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                closeHistoryModal();
            }
        }

        // 回车键计算
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateLoan();
            }
        });
    </script>
</body>
</html>
