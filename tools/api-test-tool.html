<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API调试工具 - 在线HTTP API测试工具 | 支持GET/POST/PUT/DELETE请求 | Protobuf支持</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="免费在线API调试工具，支持HTTP/HTTPS请求测试。支持GET、POST、PUT、DELETE等多种请求方法，支持JSON、Form Data、Protobuf等多种Body格式，可配置请求头、参数，查看响应结果，保存历史记录。">
    <meta name="keywords" content="API测试,API调试,HTTP测试,REST API,接口测试,在线API工具,Postman替代,API开发工具,Protobuf测试,Protocol Buffer">
    <meta name="author" content="多功能工具箱">
    <meta name="robots" content="index, follow">
    <meta name="language" content="zh-CN">
    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.seekpie.com/tools/api-test-tool.html">
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "API调试工具",
      "description": "免费在线HTTP API测试工具，支持多种请求方法和参数配置",
      "url": "https://www.seekpie.com/tools/api-test-tool.html",
      "applicationCategory": "DeveloperApplication",
      "operatingSystem": "All",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "CNY"
      },
      "featureList": [
        "支持GET/POST/PUT/DELETE等请求方法",
        "自定义请求头",
        "配置请求参数",
        "JSON/表单数据/Protobuf支持",
        "Protocol Buffer编解码",
        "响应结果查看",
        "历史记录保存"
      ]
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* 移动端触摸优化 */
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        
        /* 所有可滚动区域添加平滑滚动 */
        textarea,
        pre,
        .response-content,
        .history-list,
        .modal-body,
        [style*="overflow-y: auto"],
        [style*="overflow: auto"] {
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: clamp(10px, 2vw, 20px);
            font-size: clamp(14px, 1.5vw, 16px);
            /* 移动端滚动优化 */
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .container {
            max-width: min(1400px, 70vw);
            margin: 0 auto;
            background: white;
            border-radius: clamp(12px, 2vw, 15px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: clamp(20px, 4vw, 30px);
            text-align: center;
        }

        .header h1 {
            font-size: clamp(1.5em, 3.5vw, 2.5em);
            margin-bottom: clamp(8px, 1.5vw, 10px);
            font-weight: 300;
        }

        .header p {
            font-size: clamp(0.9em, 2vw, 1.1em);
            opacity: 0.9;
        }

        .content {
            padding: clamp(20px, 4vw, 40px);
        }

        /* 通用提示框基础样式 */
        .info-box,
        .info-tip,
        .warning-tip,
        .auth-info-box,
        .auth-warning-box,
        .response-info-section,
        .cors-warning-section,
        .browser-headers-section {
            padding: clamp(12px, 2vw, 15px);
            border-radius: clamp(4px, 0.8vw, 8px);
            margin-bottom: clamp(15px, 2.5vw, 20px);
            border-left: 4px solid;
        }

        .info-box,
        .info-tip,
        .response-info-section {
            background: #e7f3ff;
            border-left-color: #2196F3;
        }

        .warning-tip,
        .cors-warning-section {
            background: #fff9e6;
            border-left-color: #ffc107;
        }

        .auth-info-box {
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%);
            border-left-color: #667eea;
        }

        .auth-warning-box {
            background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%);
            border-left-color: #ffc107;
        }

        .browser-headers-section {
            background: #f8f9fa;
            border-left-color: #6c757d;
        }

        .info-box h4,
        .info-tip h4,
        .auth-info-box h4,
        .response-info-title,
        .response-headers-title,
        .browser-headers-title,
        .cors-warning-title {
            margin-bottom: clamp(6px, 1vw, 10px);
            font-size: clamp(0.85em, 1.6vw, 0.95em);
            font-weight: 600;
        }

        .info-box h4,
        .response-info-title {
            color: #1976D2;
        }

        .auth-info-box h4 {
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cors-warning-title {
            color: #856404;
        }

        .browser-headers-title {
            color: #666;
        }

        .info-box p,
        .info-tip,
        .auth-info-box p,
        .auth-warning-box p,
        .response-info-content,
        .cors-warning-content,
        .browser-headers-content {
            color: #666;
            line-height: 1.5;
            font-size: clamp(0.8em, 1.3vw, 0.85em);
        }

        .warning-tip,
        .cors-warning-title,
        .cors-warning-content,
        .auth-warning-box p {
            color: #856404;
        }

        .info-box code,
        code {
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: clamp(0.75em, 1.2vw, 0.8em);
            color: #667eea;
        }

        .section {
            margin-bottom: clamp(20px, 3vw, 30px);
        }

        .section-title {
            font-size: clamp(1.1em, 2.2vw, 1.3em);
            font-weight: 600;
            color: #333;
            margin-bottom: clamp(12px, 2vw, 15px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: clamp(8px, 1.5vw, 10px);
        }

        .config-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .config-actions .btn-small {
            padding: 5px 10px;
            font-size: 0.6em;
            white-space: nowrap;
        }

        /* 通用间距类 */
        .mb-8 { margin-bottom: 8px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-15 { margin-bottom: 15px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-25 { margin-bottom: 25px; }
        
        .mt-8 { margin-top: 8px; }
        .mt-10 { margin-top: 10px; }
        .mt-15 { margin-top: 15px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }

        .p-10 { padding: 10px; }
        .p-12 { padding: 12px; }
        .p-15 { padding: 15px; }
        .p-20 { padding: 20px; }

        /* 显示控制类 */
        .hidden { display: none; }
        .show { display: block; }

        /* Flex 布局类 */
        .flex { display: flex; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-gap-5 { gap: 5px; }
        .flex-gap-8 { gap: 8px; }
        .flex-gap-10 { gap: 10px; }
        .flex-gap-15 { gap: 15px; }
        .flex-gap-20 { gap: 20px; }

        /* 宽度类 */
        .w-full { width: 100%; }
        .w-auto { width: auto; }

        /* 文本对齐类 */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }

        /* 颜色类 */
        .text-success { color: #28a745; }
        .text-error { color: #dc3545; }
        .text-warning { color: #ffc107; }
        .text-info { color: #17a2b8; }
        .text-muted { color: #666; }

        /* 字体大小类 */
        .text-sm { font-size: 0.85em; }
        .text-md { font-size: 0.95em; }
        .text-lg { font-size: 1.1em; }
        .text-xl { font-size: 1.3em; }

        /* 字体粗细类 */
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        /* 提示框样式已合并到上方通用样式 */

        /* 通用表单控件样式 */
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="url"],
        textarea,
        select,
        .url-input,
        .auth-input,
        .auth-textarea,
        .auth-select,
        .proto-textarea,
        .proto-select,
        .key-value-row input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 0.95em;
            background: white;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        textarea,
        .auth-textarea,
        .proto-textarea,
        .url-input,
        .auth-input,
        .key-value-row input[type="text"] {
            font-family: 'Consolas', 'Monaco', monospace;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="url"]:focus,
        textarea:focus,
        select:focus,
        .url-input:focus,
        .auth-input:focus,
        .auth-textarea:focus,
        .auth-select:focus,
        .proto-textarea:focus,
        .proto-select:focus,
        .key-value-row input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-input,
        .auth-textarea {
            background: #f8f9fa;
        }

        .auth-input:focus,
        .auth-textarea:focus {
            background: white;
        }

        textarea,
        .auth-textarea {
            min-height: 120px;
            resize: vertical;
        }

        select,
        .auth-select,
        .proto-select {
            cursor: pointer;
        }

        .proto-label,
        label {
            display: block;
            font-weight: 600;
            color: #555;
        }

        .proto-message-type-group {
            display: none;
            margin-bottom: 15px;
        }

        .proto-encoded-preview {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .proto-encoded-content {
            padding: 10px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }

        /* Protobuf配置区域 */
        .protobuf-config-wrapper {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .protobuf-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .protobuf-config-title {
            margin: 0;
            color: #4facfe;
            font-size: 1.2em;
        }

        .protobuf-config-subtitle {
            font-size: 0.75em;
            color: #999;
            font-weight: normal;
        }

        .protobuf-toggle-icon {
            font-size: 1.5em;
            transition: transform 0.3s;
        }

        .protobuf-config-content {
            display: none;
            margin-top: 15px;
        }

        .protobuf-status {
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            display: none;
        }

        /* 按钮组 */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .button-group-mb {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        /* 表单组 */
        .form-group {
            margin-bottom: 15px;
        }

        /* 响应头显示相关 */
        .response-headers-section {
            margin-bottom: 15px;
        }

        /* 响应相关特殊样式 */
        .response-headers-title {
            color: #4facfe;
        }

        .response-headers-count {
            margin-bottom: 10px;
            font-size: 0.8em;
            color: #666;
        }

        .no-content {
            color: #999;
            font-style: italic;
            padding: 10px 0;
            font-size: 0.85em;
        }

        .browser-headers-section,
        .cors-warning-section,
        .response-info-section {
            margin-top: 20px;
        }

        .browser-note {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.75em;
            color: #999;
            font-style: italic;
        }

        .cors-example {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ffc107;
            font-size: 0.8em;
            color: #856404;
        }

        .cors-code-block {
            margin-top: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8em;
        }

        .cors-code {
            color: #d63384;
        }

        .cors-code-note {
            font-size: 0.75em;
            color: #666;
        }

        .response-info-content {
            color: #1976D2;
        }

        /* 预格式化文本 */
        .pre-wrap {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .request-line {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .method-select {
            width: 140px;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .method-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .url-input {
            flex: 1;
            min-height: 44px;
        }

        .btn {
            padding: clamp(10px, 1.5vw, 12px) clamp(20px, 3vw, 30px);
            border: none;
            border-radius: clamp(8px, 1.2vw, 10px);
            font-size: clamp(0.9em, 1.5vw, 1em);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            /* 确保触摸目标足够大 */
            min-height: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-width: clamp(100px, 15vw, 120px);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            border-bottom: 2px solid #e1e5e9;
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #666;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .key-value-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .key-value-row {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        .key-value-row input[type="text"],
        .key-value-row input[type="checkbox"] {
            transition: all 0.3s ease;
        }

        /* key-value-row input 样式已合并到通用表单控件样式 */

        .key-value-row input[type="checkbox"] {
            flex-shrink: 0;
            margin: 0;
        }

        .key-value-row .delete-btn {
            flex-shrink: 0;
            white-space: nowrap;
        }

        /* 优化datalist下拉框样式 */
        .key-value-row input[type="text"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            filter: invert(50%);
        }

        .key-value-row input[type="text"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* 自定义下拉建议列表 */
        .autocomplete-wrapper {
            position: relative;
            flex: 1;
            min-width: 0; /* 允许flex子项缩小到内容以下 */
        }

        .autocomplete-wrapper.wide {
            flex: 2;
            min-width: 0;
        }

        .autocomplete-wrapper input {
            width: 100%;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            display: none;
        }

        .autocomplete-suggestions.show {
            display: block;
        }

        .autocomplete-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestion:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .autocomplete-suggestion.selected {
            background: #e7f3ff;
        }

        .key-value-row .key-input {
            flex: 1;
            min-width: 0;
        }

        .key-value-row .value-input {
            flex: 2;
            min-width: 0;
        }

        /* 当input直接在key-value-row中时（没有wrapper包裹） */
        .key-value-row > .key-input,
        .key-value-row > .value-input {
            width: auto;
        }

        .key-value-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .key-value-row .delete-btn {
            padding: 8px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .key-value-row .delete-btn:hover {
            background: #c82333;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 0.95em;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: vertical;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .body-type-select {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .body-type-option {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .body-type-option:hover {
            background: #e9ecef;
        }

        .body-type-option.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .auth-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .auth-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-type-selector {
            margin-bottom: 25px;
        }

        .auth-input-group {
            margin-bottom: 20px;
        }

        .auth-input-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 1em;
        }

        /* Auth 相关样式已合并到通用表单控件和提示框样式 */
        
        .auth-input[type="password"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .auth-info-box,
        .auth-warning-box {
            margin-top: 20px;
        }

        .auth-warning-box p {
            margin: 0;
        }

        .response-section {
            margin-top: 30px;
            display: none;
        }

        .response-section.show {
            display: block;
        }

        .response-status {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .status-item {
            flex: 1;
            min-width: 150px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e1e5e9;
        }

        .status-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .status-value.success {
            color: #28a745;
        }

        .status-value.error {
            color: #dc3545;
        }

        .response-box {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            margin-bottom: 20px;
        }

        .response-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .response-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* 语法高亮样式 - JSON */
        .json-key {
            color: #881391;
            font-weight: 600;
        }

        .json-string {
            color: #1A1AA6;
        }

        .json-number {
            color: #1C00CF;
        }

        .json-boolean {
            color: #0D22FF;
            font-weight: 600;
        }

        .json-null {
            color: #808080;
            font-style: italic;
        }

        /* 语法高亮样式 - XML */
        .xml-tag {
            color: #800000;
        }

        .xml-tag-name {
            color: #800000;
            font-weight: 600;
        }

        .xml-attr {
            color: #FF0000;
        }

        .xml-string {
            color: #0000FF;
        }

        .xml-punct {
            color: #000000;
        }

        /* 语法高亮样式 - HTML */
        .html-tag {
            color: #800000;
        }

        .html-tag-name {
            color: #800000;
            font-weight: 600;
        }

        .html-attr {
            color: #FF0000;
        }

        .html-string {
            color: #0000FF;
        }

        .html-punct {
            color: #000000;
        }

        .html-comment {
            color: #008000;
            font-style: italic;
        }

        .copy-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .history-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e1e5e9;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-header h3 {
            color: #333;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .clear-history-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .clear-history-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: #4facfe;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.2);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }

        .history-item-header > div:first-child {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }

        .history-item-method {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .method-GET {
            background: #28a745;
            color: white;
        }

        .method-POST {
            background: #ffc107;
            color: #333;
        }

        .method-PUT {
            background: #17a2b8;
            color: white;
        }

        .method-DELETE {
            background: #dc3545;
            color: white;
        }

        .method-PATCH {
            background: #6f42c1;
            color: white;
        }

        .history-item-url {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #555;
            word-break: break-all;
            overflow-wrap: break-word;
            word-wrap: break-word;
            flex: 1;
            min-width: 0;
        }

        .history-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .history-item-date {
            color: #999;
            font-size: 0.85em;
        }

        .delete-history-btn {
            padding: 4px 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .delete-history-btn:hover {
            background: #c82333;
        }

        .history-item-status {
            margin-top: 8px;
            font-size: 0.85em;
            color: #666;
        }

        .empty-history {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 500;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 2px solid #e1e5e9;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        /* 变量提示样式 */
        .variable-hint {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
            min-width: 200px;
        }

        .variable-hint.show {
            display: block;
        }

        .variable-hint-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .variable-hint-item:last-child {
            border-bottom: none;
        }

        .variable-hint-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .variable-hint-key {
            font-weight: 600;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .variable-hint-value {
            font-size: 0.85em;
            color: #666;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .variable-hint-item:hover .variable-hint-value {
            color: rgba(255, 255, 255, 0.8);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            align-items: center;
        }
        
        .env-selector-group {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .env-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .env-select:hover {
            border-color: #4facfe;
        }
        
        .env-select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .env-management {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 移动端优化 */
        /* 超大屏幕优化 */
        @media (min-width: 1920px) {
            body {
                font-size: 18px;
            }
            
            .container {
                max-width: 1400px;
            }
        }

        /* 大屏幕优化 (桌面) */
        @media (min-width: 1200px) and (max-width: 1919px) {
            .container {
                max-width: min(1000px, 80vw);
            }
        }

        /* 平板横屏 */
        @media (min-width: 769px) and (max-width: 1199px) {
            .container {
                max-width: min(900px, 85vw);
            }
        }

        /* 平板竖屏和移动端横屏 */
        @media (max-width: 768px) {
            .container {
                max-width: 95vw;
            }

            body {
                padding: 10px;
            }

            .content {
                padding: 20px 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 0.95em;
            }

            .request-line {
                flex-direction: column;
            }

            .method-select {
                width: 100%;
            }

            .btn {
                width: 100%;
            }
            
            /* 环境选择器移动端优化 */
            .button-group {
                flex-direction: column;
                gap: 12px;
                width: 100%;
            }
            
            .env-selector-group {
                width: 100%;
                justify-content: space-between;
            }
            
            .env-selector-group label {
                font-size: 14px;
            }
            
            .env-select {
                flex: 1;
                min-width: 0;
                font-size: 13px;
            }
            
            .button-group > .btn {
                width: 100%;
            }
            
            /* 模态框移动端优化 */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-header h2 {
                font-size: 1.3em;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-footer {
                padding: 15px;
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
            
            /* 环境管理区域移动端优化 */
            .env-management {
                padding: 12px;
            }
            
            .env-management > div {
                flex-direction: column !important;
                gap: 10px !important;
                align-items: stretch !important;
            }
            
            .env-management .form-label-inline {
                width: 100%;
                margin-bottom: 5px;
                font-size: 14px;
            }
            
            .env-management select {
                max-width: 100% !important;
                width: 100% !important;
                min-height: 44px;
                font-size: 14px;
            }
            
            .env-management .btn {
                width: 100%;
                justify-content: center;
            }

            .tabs {
                flex-direction: column;
                gap: 8px;
                border-bottom: none;
                padding-bottom: 0;
            }

            .tab {
                width: 100%;
                text-align: center;
                border-radius: 8px;
            }

            /* 提示框字体缩小 */
            .info-box {
                font-size: 13px;
            }

            .info-box h4 {
                font-size: 14px;
            }

            .info-box code {
                font-size: 12px;
                word-break: break-all;
            }

            .key-value-row {
                flex-wrap: wrap;
            }

            /* Checkbox和删除按钮放在同一行 */
            .key-value-row input[type="checkbox"] {
                order: 1;
                flex-shrink: 0;
            }

            .key-value-row .delete-btn {
                order: 2;
                flex-shrink: 0;
                min-width: 60px;
                margin-left: auto;
            }

            /* 输入框独占一行 - 针对有 autocomplete-wrapper 的（Headers） */
            .key-value-row .autocomplete-wrapper {
                order: 3;
                flex: 1 1 100%;
                max-width: 100%;
                margin-top: 8px;
            }

            .key-value-row .autocomplete-wrapper.wide {
                order: 4;
                flex: 1 1 100%;
                max-width: 100%;
                margin-top: 8px;
            }

            /* 如果是在 autocomplete-wrapper 内的输入框，保持100%宽度 */
            .key-value-row .autocomplete-wrapper .key-input,
            .key-value-row .autocomplete-wrapper .value-input {
                width: 100%;
                order: initial;
                margin-top: 0;
            }

            /* 如果input没有包裹在wrapper中（Params, PathVars） */
            .key-value-row > .key-input {
                order: 3;
                flex: 1 1 100%;
                margin-top: 8px;
            }

            .key-value-row > .value-input {
                order: 4;
                flex: 1 1 100%;
                margin-top: 8px;
            }

            .response-status {
                flex-direction: column;
            }

            .status-item {
                min-width: 100%;
            }

            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .clear-history-btn {
                width: 100%;
            }

            .history-item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .history-item-header > div:first-child {
                width: 100%;
            }

            .history-item-url {
                width: 100%;
                word-break: break-all;
            }

            .history-item-actions {
                width: 100%;
                justify-content: space-between;
            }

            .body-type-select {
                flex-direction: column;
            }

            .body-type-option {
                text-align: center;
            }

            .autocomplete-wrapper {
                flex: 1 1 100%;
            }

            .autocomplete-suggestions {
                font-size: 0.9em;
                max-height: 150px;
            }

            .autocomplete-suggestion {
                padding: 8px 12px;
            }

            .auth-input, .auth-textarea, .auth-select {
                font-size: 0.95em;
            }

            .auth-textarea {
                min-height: 110px;
            }

            .auth-input-group {
                margin-bottom: 18px;
            }

            .auth-info-box, .auth-warning-box {
                padding: 13px 16px;
            }
            
            /* Response标签页移动端优化 */
            .response-tabs {
                flex-wrap: wrap;
            }
            
            .response-tabs .response-tab {
                flex: 1 1 calc(50% - 5px);
                min-width: calc(50% - 5px);
            }
            
            /* 变量提示移动端优化 */
            .variable-hint-popup {
                max-width: 90%;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }

            .content {
                padding: 15px 12px;
            }

            .section-title {
                font-size: 1.1em;
                flex-wrap: wrap;
            }

            .config-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .config-actions .btn-small {
                flex: 1;
                min-width: 120px;
            }

            textarea {
                min-height: 150px;
                font-size: 0.85em;
            }

            .response-content {
                font-size: 0.85em;
                max-height: 300px;
            }

            .autocomplete-wrapper {
                flex: 1 1 100%;
                max-width: 100%;
            }

            .autocomplete-wrapper.wide {
                flex: 1 1 100%;
                max-width: 100%;
            }

            .autocomplete-suggestions {
                font-size: 0.85em;
                max-height: 120px;
            }

            .autocomplete-suggestion {
                padding: 6px 10px;
            }

            .auth-input, .auth-textarea, .auth-select {
                font-size: 0.85em;
                padding: 10px 12px;
            }

            .auth-textarea {
                min-height: 100px;
            }

            .auth-input-group {
                margin-bottom: 12px;
            }

            .auth-input-group label {
                font-size: 0.9em;
                margin-bottom: 8px;
            }

            .auth-info-box, .auth-warning-box {
                padding: 10px 12px;
                margin-top: 15px;
            }

            .auth-info-box h4 {
                font-size: 0.9em;
            }

            .auth-info-box p, .auth-warning-box p {
                font-size: 0.85em;
            }

            .auth-type-selector {
                margin-bottom: 20px;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .modal-header {
                padding: 20px 15px;
            }

            .modal-header h2 {
                font-size: 1.3em;
            }

            .modal-body {
                padding: 20px 15px;
            }

            .modal-footer {
                padding: 15px;
                flex-direction: column;
            }

            .modal-footer .btn {
                width: 100%;
            }
            
            /* 环境选择器超小屏优化 */
            .env-selector-group label {
                font-size: 12px;
            }
            
            .env-select {
                font-size: 12px;
                padding: 5px 8px;
            }
            
            /* 环境管理区域超小屏优化 */
            .env-management {
                padding: 10px;
            }
            
            .env-management .form-label-inline {
                font-size: 13px;
            }
            
            .env-management select {
                font-size: 13px;
                padding: 8px 10px;
                min-height: 44px;
            }
            
            .env-management .btn-small {
                font-size: 13px;
                padding: 8px 12px;
                white-space: normal;
                line-height: 1.3;
            }
            
            /* 输入框字体大小 */
            .key-input, .value-input {
                font-size: 14px;
            }
            
            /* 按钮字体大小 */
            .btn {
                font-size: 14px;
                padding: 10px 16px;
            }
            
            /* Response标签页超小屏优化 */
            .response-tabs .response-tab {
                flex: 1 1 100%;
                min-width: 100%;
                font-size: 13px;
            }
            
            /* 快速创建环境按钮移动端优化 */
            .modal-body > div > div[style*="display: flex; gap: 8px;"] .btn-small {
                flex: 1 1 calc(50% - 4px);
                min-width: calc(50% - 4px);
            }
            
            /* 历史记录项移动端优化 */
            .history-item-method {
                font-size: 11px;
                padding: 3px 8px;
            }

            .history-item-url {
                font-size: 12px;
            }

            .history-item-date {
                font-size: 11px;
            }

            .delete-history-btn {
                font-size: 12px;
                padding: 4px 10px;
            }

            .history-item-status {
                font-size: 12px;
            }

            .btn-small {
                font-size: 13px;
                padding: 7px 13px;
            }

            .info-box {
                font-size: 12px;
            }

            .info-box code {
                font-size: 11px;
            }

            .body-type-option {
                font-size: 13px;
                padding: 10px;
            }
        }
        
        /* 新增工具类 - 替代内联样式 */
        .modal-wide {
            max-width: 900px;
        }
        
        .modal-medium {
            max-width: 500px;
        }
        
        .mb-20 {
            margin-bottom: 20px;
        }
        
        .mb-15 {
            margin-bottom: 15px;
        }
        
        .mb-10 {
            margin-bottom: 10px;
        }
        
        .mb-12 {
            margin-bottom: 12px;
        }
        
        .mb-8 {
            margin-bottom: 8px;
        }
        
        .pt-15 {
            padding-top: 15px;
        }
        
        /* Flex 工具类已合并到通用样式 */
        .flex-row {
            display: flex;
            align-items: center;
        }
        
        .border-top {
            border-top: 1px solid #e0e0e0;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #666;
        }
        
        .form-label-inline {
            color: #666;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .full-width {
            width: 100%;
        }
        
        .env-select-wrapper {
            flex: 1;
            max-width: 300px;
        }
        
        .section-heading {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.85em;
        }
        
        .info-note {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 8px 12px;
            margin-bottom: 12px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        .success-note {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 8px 12px;
            margin-bottom: 12px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        .quick-env-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .env-label {
            margin-right: 8px;
            color: #666;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .btn-disabled-visual {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 触摸设备优化 */
        @media (hover: none) {
            /* 增加触摸目标大小 */
            .btn, .tab, .body-type-option, .delete-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .key-input, .value-input, input[type="text"], textarea, select {
                min-height: 44px;
                font-size: 16px; /* 防止iOS自动缩放 */
            }
            
            /* 移除hover效果 */
            .btn:hover, .tab:hover, .body-type-option:hover {
                transform: none;
            }
            
            /* 添加active效果 */
            .btn:active {
                transform: scale(0.98);
                opacity: 0.8;
            }
            
            .tab:active, .body-type-option:active {
                opacity: 0.8;
            }
        }

        /* 横屏模式优化（移动设备） */
        @media (max-width: 768px) and (orientation: landscape) {
            body {
                padding: 8px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.85em;
            }
            
            .content {
                padding: 15px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .modal-content {
                max-height: 85vh;
            }
            
            /* 环境管理区域横屏优化 */
            .env-management {
                padding: 10px;
            }
            
            .env-management > div {
                flex-wrap: wrap;
                gap: 8px !important;
            }
            
            .env-management .form-label-inline {
                width: 100%;
                font-size: 13px;
                margin-bottom: 3px;
            }
            
            .env-management select {
                flex: 1 1 100%;
                min-width: 100%;
                font-size: 13px;
            }
            
            .env-management .btn {
                flex: 1 1 calc(50% - 4px);
                font-size: 12px;
                padding: 8px 10px;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 360px) {
            body {
                font-size: 13px;
            }
            
            .content {
                padding: 12px;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.85em;
            }
            
            .section-title {
                font-size: 1em;
            }
            
            /* 环境管理区域超超小屏优化 */
            .env-management {
                padding: 8px;
            }
            
            .env-management .form-label-inline {
                font-size: 12px;
                margin-bottom: 5px;
            }
            
            .env-management select {
                font-size: 12px;
                padding: 8px;
            }
            
            .env-management .btn-small {
                font-size: 12px;
                padding: 8px 10px;
            }
        }

        /* 打印样式优化 */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            
            .header {
                background: #4facfe !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .btn, .delete-btn, .add-row-btn {
                display: none;
            }
            
            .response-section {
                page-break-before: always;
            }
            
            .section {
                page-break-inside: avoid;
            }
            
            .response-content {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 API调试工具</h1>
            <p>强大的HTTP API测试工具，支持多种请求方法和参数配置</p>
        </div>

        <div class="content">
            <div class="info-box">
                <h4>📘 使用说明</h4>
                <p>API调试工具，支持发送HTTP请求、配置请求头、参数和请求体。支持 JSON、Form Data、Protobuf 等多种 Body 格式。可以测试 RESTful API、Protocol Buffer API、查看响应结果，并自动保存请求历史记录。</p>
            </div>

            <!-- 请求配置区域 -->
            <div class="section">
                <div class="section-title">
                    <span>📤 请求配置</span>
                    <div class="config-actions">
                        <button class="btn-small btn-secondary" onclick="exportConfiguration()" title="导出所有配置">📥 导出配置</button>
                        <button class="btn-small btn-secondary" onclick="importConfiguration()" title="导入配置">📤 导入配置</button>
                    </div>
                </div>
                
                <div class="request-line">
                    <select id="httpMethod" class="method-select">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                        <option value="HEAD">HEAD</option>
                        <option value="OPTIONS">OPTIONS</option>
                    </select>
                    <input type="text" id="apiUrl" class="url-input" placeholder="请输入API地址，例如：https://api.example.com/users">
                    <button class="btn btn-primary" id="sendBtn" onclick="sendRequest()">发送请求</button>
                </div>

                <div class="button-group">
                    <div class="env-selector-group">
                        <label for="environmentSelect" class="env-label">🌍 环境：</label>
                        <select id="environmentSelect" class="env-select" onchange="switchEnvironment()">
                            <option value="default">默认环境</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="openVariablesModal()">⚙️ 全局变量</button>
                    <button class="btn btn-warning btn-small" onclick="clearAll()">🗑️ 清空所有</button>
                </div>
            </div>

            <!-- 请求参数标签页 -->
            <div class="section">
                <div class="tabs">
                    <div class="tab active" onclick="switchRequestTab('params')">Query Params</div>
                    <div class="tab" onclick="switchRequestTab('pathVars')">Path Variables</div>
                    <div class="tab" onclick="switchRequestTab('authorization')">Authorization</div>
                    <div class="tab" onclick="switchRequestTab('headers')">Headers</div>
                    <div class="tab" onclick="switchRequestTab('body')">Body</div>
                    <div class="tab" onclick="switchRequestTab('response')">Response</div>
                </div>

                <!-- Query Params -->
                <div id="params" class="tab-content active"> 
                    <div class="info-box mb-15">
                        <h4>💡 使用提示</h4>
                        <p>在URL中输入带查询参数的地址会自动解析（鼠标离开输入框后触发），例如：<br>
                        <code>https://api.example.com/users?id=123&name=John</code><br>
                        <code>{{baseUrl}}/api/users?id=123&name=John</code> <br>
                        参数将自动提取到下方列表</p>
                    </div>
                    <div id="paramsList" class="key-value-list"></div>
                    <button class="btn btn-secondary btn-small" onclick="addParam()">➕ 添加参数</button>
                </div>

                <!-- Path Variables -->
                <div id="pathVars" class="tab-content">
                    <div class="info-box mb-15">
                        <h4>💡 使用提示</h4>
                        <p>在URL中使用 <code>{变量名}</code> 或 <code>:变量名</code> 格式定义路径参数，例如：<br>
                        <code>{{baseUrl}}/users/{userId}/posts/:postId</code></p>
                        <p class="mt-8">⚠️ 注意：<code>{{变量名}}</code> 格式是全局变量，不会被识别为路径参数</p>
                    </div>
                    <div id="pathVarsList" class="key-value-list"></div>
                    <button class="btn btn-secondary btn-small" onclick="addPathVar()">➕ 添加路径参数</button>
                </div>

                <!-- Authorization -->
                <div id="authorization" class="tab-content">
                    <div class="info-tip">
                        <strong>💡 提示：</strong> Authorization 配置会自动保存到本地缓存，刷新页面后自动恢复。
                    </div>
                    <div class="auth-type-selector">
                        <div class="input-group">
                            <label>🔐 认证类型</label>
                            <select id="authType" class="auth-select" onchange="switchAuthType()">
                                <option value="none">🚫 No Auth - 无认证</option>
                                <option value="bearer">🎫 Bearer Token</option>
                                <option value="basic">🔑 Basic Auth</option>
                                <option value="apikey">🗝️ API Key</option>
                                <option value="digest">🔐 Digest Auth</option>
                                <option value="oauth2">🌐 OAuth 2.0</option>
                            </select>
                        </div>
                    </div>

                    <!-- No Auth -->
                    <div id="authNone" class="auth-content active">
                        <div class="alert alert-info">
                            ℹ️ 当前请求不使用任何认证方式
                        </div>
                    </div>

                    <!-- Bearer Token -->
                    <div id="authBearer" class="auth-content hidden">
                        <div class="auth-input-group">
                            <label>🎫 Token</label>
                            <textarea id="bearerToken" class="auth-textarea" placeholder="请输入Bearer Token，例如：&#10;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"></textarea>
                        </div>
                        <div class="auth-info-box">
                            <h4>📘 Bearer Token说明</h4>
                            <p>Bearer Token是最常见的API认证方式，通常用于JWT认证。Token将被自动添加到请求头：<br>
                            <code>Authorization: Bearer {your_token}</code></p>
                        </div>
                    </div>

                    <!-- Basic Auth -->
                    <div id="authBasic" class="auth-content hidden">
                        <div class="auth-input-group">
                            <label>👤 用户名</label>
                            <input type="text" id="basicUsername" class="auth-input" placeholder="请输入用户名">
                        </div>
                        <div class="auth-input-group">
                            <label>🔒 密码</label>
                            <input type="password" id="basicPassword" class="auth-input" placeholder="请输入密码">
                        </div>
                        <div class="auth-info-box">
                            <h4>📘 Basic Auth说明</h4>
                            <p>Basic Auth使用Base64编码的用户名和密码进行认证。将被自动添加到请求头：<br>
                            <code>Authorization: Basic {base64(username:password)}</code></p>
                        </div>
                    </div>

                    <!-- API Key -->
                    <div id="authApiKey" class="auth-content hidden">
                        <div class="auth-input-group">
                            <label>📝 Key名称</label>
                            <input type="text" id="apiKeyName" class="auth-input" placeholder="例如：X-API-Key, api_key, apikey" value="X-API-Key">
                        </div>
                        <div class="auth-input-group">
                            <label>🔑 Key值</label>
                            <input type="text" id="apiKeyValue" class="auth-input" placeholder="请输入API Key">
                        </div>
                        <div class="auth-input-group">
                            <label>📍 添加位置</label>
                            <select id="apiKeyLocation" class="auth-select">
                                <option value="header">Header（请求头）</option>
                                <option value="query">Query Params（URL参数）</option>
                            </select>
                        </div>
                        <div class="auth-info-box">
                            <h4>📘 API Key说明</h4>
                            <p>API Key可以灵活地添加到请求头或URL参数中。<br>
                            • <strong>Header方式</strong>: <code>{key_name}: {key_value}</code><br>
                            • <strong>Query方式</strong>: <code>?{key_name}={key_value}</code></p>
                        </div>
                    </div>

                    <!-- Digest Auth -->
                    <div id="authDigest" class="auth-content hidden">
                        <div class="auth-input-group">
                            <label>👤 用户名</label>
                            <input type="text" id="digestUsername" class="auth-input" placeholder="请输入用户名">
                        </div>
                        <div class="auth-input-group">
                            <label>🔒 密码</label>
                            <input type="password" id="digestPassword" class="auth-input" placeholder="请输入密码">
                        </div>
                        <div class="auth-warning-box">
                            <p>⚠️ <strong>注意：</strong>Digest Auth需要服务器返回401响应和challenge信息。在浏览器环境中可能不完全支持此认证方式。</p>
                        </div>
                    </div>

                    <!-- OAuth 2.0 -->
                    <div id="authOAuth2" class="auth-content hidden">
                        <div class="auth-input-group">
                            <label>🌐 Access Token</label>
                            <textarea id="oauth2Token" class="auth-textarea" placeholder="请输入OAuth 2.0 Access Token&#10;例如：ya29.a0AfH6SMBx..."></textarea>
                        </div>
                        <div class="auth-input-group">
                            <label>🏷️ Token类型（可选）</label>
                            <input type="text" id="oauth2TokenType" class="auth-input" placeholder="默认为 Bearer" value="Bearer">
                        </div>
                        <div class="auth-info-box">
                            <h4>📘 OAuth 2.0说明</h4>
                            <p>OAuth 2.0是一个授权框架，允许应用程序访问用户资源。Access Token将被添加到请求头：<br>
                            <code>Authorization: {token_type} {access_token}</code><br><br>
                            <strong>注意：</strong>完整的OAuth 2.0授权流程（Authorization Code、Implicit等）需要在服务端完成，此处仅支持使用已获取的Access Token。</p>
                        </div>
                    </div>
                </div>

                <!-- Headers -->
                <div id="headers" class="tab-content">
                    <div id="headersList" class="key-value-list"></div>
                    <button class="btn btn-secondary btn-small" onclick="addHeader()">➕ 添加请求头</button>
                </div>

                <!-- Body -->
                <div id="body" class="tab-content">
                    <div class="body-type-select">
                        <div class="body-type-option active" onclick="switchBodyType('none')">None</div>
                        <div class="body-type-option" onclick="switchBodyType('json')">JSON</div>
                        <div class="body-type-option" onclick="switchBodyType('form')">Form Data</div>
                        <div class="body-type-option" onclick="switchBodyType('text')">Raw Text</div>
                        <div class="body-type-option" onclick="switchBodyType('protobuf')">Protobuf</div>
                    </div>

                    <div id="bodyNone" class="body-content active">
                        <div class="alert alert-info">当前请求不包含Body内容</div>
                    </div>

                    <div id="bodyJson" class="body-content hidden">
                        <textarea id="jsonBody" placeholder='请输入JSON格式的数据，例如：&#10;{&#10;  "name": "John Doe",&#10;  "email": "john@example.com"&#10;}'></textarea>
                    </div>

                    <div id="bodyForm" class="body-content hidden">
                        <div id="formDataList" class="key-value-list"></div>
                        <button class="btn btn-secondary btn-small" onclick="addFormData()">➕ 添加字段</button>
                    </div>

                    <div id="bodyText" class="body-content hidden">
                        <textarea id="textBody" placeholder="请输入纯文本内容..."></textarea>
                    </div>

                    <div id="bodyProtobuf" class="body-content hidden">
                        <div class="alert alert-info mb-15">
                            <strong>💡 提示：</strong> 将 JSON 数据编码为 Protocol Buffer 格式发送。
                        </div>
                        
                        <!-- Proto 定义 -->
                        <div class="form-group">
                            <label class="proto-label">
                                Proto 定义 (用于请求Body):
                            </label>
                            <div id="requestProtoCacheStatus" class="warning-tip hidden">
                                <span id="requestProtoCacheStatusText"></span>
                            </div>
                            <textarea id="requestProtoDefinition" rows="8" class="proto-textarea" placeholder='syntax = "proto3";

message Request {
  string name = 1;
  int32 age = 2;
  string email = 3;
}'></textarea>
                        </div>
                        
                        <div class="button-group-mb">
                            <button class="btn btn-primary btn-small" onclick="parseRequestProto()">
                                🔍 解析 Proto
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="clearRequestProto()">
                                🗑️ 清空
                            </button>
                        </div>
                        
                        <div id="requestProtoMessageTypeGroup" class="proto-message-type-group">
                            <label class="proto-label">消息类型：</label>
                            <select id="requestProtoMessageType" class="proto-select">
                                <option value="">-- 请先解析 Proto --</option>
                            </select>
                        </div>
                        
                        <!-- JSON 输入 -->
                        <div class="form-group">
                            <label class="proto-label">
                                JSON 数据 (将被编码为 Protobuf):
                            </label>
                            <textarea id="protobufJsonInput" rows="8" class="proto-textarea" placeholder='{
  "name": "John Doe",
  "age": 30,
  "email": "john@example.com"
}'></textarea>
                        </div>
                        
                        <!-- 编码预览 -->
                        <div id="protobufEncodedPreview" class="proto-encoded-preview">
                            <label class="proto-label">编码预览 (Hex):</label>
                            <div class="proto-encoded-content" id="protobufEncodedHex"></div>
                        </div>
                    </div>
                </div>

                <!-- Response -->
                <div id="response" class="tab-content">
                    <div class="info-tip">
                        <strong>💡 提示：</strong> 配置响应数据的解析方式，例如 Protocol Buffer 格式的响应解码。
                    </div>

                    <!-- Protobuf配置区域 -->
                    <div class="protobuf-config-wrapper">
                        <div class="protobuf-config-header" onclick="toggleProtobufConfig()">
                            <h3 class="protobuf-config-title">
                                📦 Protocol Buffer 配置 
                                <span class="protobuf-config-subtitle">(用于解析 protobuf 响应)</span>
                            </h3>
                            <span id="protobufToggleIcon" class="protobuf-toggle-icon">▼</span>
                        </div>
                        
                        <div id="protobufConfigContent" class="protobuf-config-content">
                            <div class="info-tip">
                                <strong>💡 提示：</strong> 当API返回 <code>application/x-protobuf</code> 或 <code>application/protobuf</code> 格式的响应时，需要配置Proto定义才能自动解码。
                            </div>
                            
                            <div class="form-group">
                                <label class="proto-label">Proto 定义：</label>
                                <textarea id="protoDefinition" rows="8" class="proto-textarea" placeholder='syntax = "proto3";

message Response {
  int32 code = 1;
  string message = 2;
  bytes data = 3;
}'></textarea>
                            </div>
                            
                            <div class="form-group proto-message-type-group" id="protobufMessageTypeGroup">
                                <label class="proto-label">消息类型：</label>
                                <select id="protobufMessageTypeSelect" class="proto-select">
                                    <option value="">-- 请先解析 Proto --</option>
                                </select>
                            </div>
                            
                            <div class="button-group">
                                <button class="btn btn-primary btn-small" onclick="parseProtoDefinition()">
                                    🔍 解析 Proto
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="clearProtoDefinition()">
                                    🗑️ 清空
                                </button>
                                <span id="protobufStatus" class="protobuf-status"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 响应区域 -->
            <div id="responseSection" class="response-section">
                <div class="section-title">📥 响应结果</div>

                <div class="response-status" id="responseStatus"></div>

                <div class="tabs">
                    <div class="tab active" onclick="switchResponseTab('responseBody')">Response Body</div>
                    <div class="tab" onclick="switchResponseTab('requestHeaders')">Request Headers</div>
                    <div class="tab" onclick="switchResponseTab('responseHeaders')">Response Headers</div>
                </div>

                <div id="responseBody" class="tab-content active">
                    <div class="response-box">
                        <h3>响应内容</h3>
                        <button class="copy-btn" onclick="copyResponse('responseContent', event)">📋 复制</button>
                        <div id="responseContent" class="response-content"></div>
                    </div>
                </div>

                <div id="requestHeaders" class="tab-content">
                    <div class="response-box">
                        <h3>请求头</h3>
                        <div class="info-note">
                            <strong>ℹ️ 说明：</strong> 显示所有配置的请求头。浏览器还会自动添加一些标准头（如User-Agent、Accept、Origin等），这些头由浏览器控制，无法通过JavaScript获取完整列表。
                        </div>
                        <button class="copy-btn" onclick="copyResponse('requestHeadersContent', event)">📋 复制</button>
                        <div id="requestHeadersContent" class="response-content"></div>
                    </div>
                </div>

                <div id="responseHeaders" class="tab-content">
                    <div class="response-box">
                        <h3>响应头</h3>
                        <div class="success-note">
                            <strong>✅ 说明：</strong> 显示服务器返回的所有可访问的HTTP响应头。包括标准头（如content-type、date）和自定义头（需服务器CORS配置）。某些头（如Set-Cookie）因浏览器安全策略无法通过JavaScript访问。
                        </div>
                        <button class="copy-btn" onclick="copyResponse('responseHeadersContent', event)">📋 复制</button>
                        <div id="responseHeadersContent" class="response-content"></div>
                    </div>
                </div>
            </div>

            <!-- 历史记录 -->
            <div class="history-section">
                <div class="history-header">
                    <h3>📜 请求历史</h3>
                    <button class="clear-history-btn" onclick="clearHistory()">清空历史</button>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>
            
            <!-- 隐藏的文件输入 -->
            <input type="file" id="configFileInput" accept=".json" class="hidden" onchange="handleConfigFileSelect(event)">
        </div>

        <!-- 全局变量管理弹窗 -->
        <div id="variablesModal" class="modal">
            <div class="modal-content modal-wide">
                <div class="modal-header">
                    <h2>⚙️ 全局变量管理</h2>
                    <button class="modal-close" onclick="closeVariablesModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="info-box mb-20">
                        <h4>💡 使用说明</h4>
                        <p>• 使用 <code>{{变量名}}</code> 格式在任何输入框中引用变量<br>
                        • 支持在URL、参数、Headers、Body等位置使用<br>
                        • 例如：URL输入 <code>{{baseUrl}}/users/{{userId}}</code><br>
                        • 不同环境可以配置不同的变量值（如开发、测试、生产环境）</p>
                    </div>
                    
                    <!-- 环境管理区域 -->
                    <div class="env-management mb-20">
                        <div class="flex-row flex-gap-10">
                            <label class="form-label-inline">🌍 当前环境：</label>
                            <select id="modalEnvironmentSelect" class="env-select env-select-wrapper" onchange="switchModalEnvironment()">
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="showAddEnvironmentDialog()">➕ 新建环境</button>
                            <button class="btn btn-warning btn-small" onclick="deleteCurrentEnvironment()" id="deleteEnvBtn">🗑️ 删除环境</button>
                        </div>
                    </div>
                    
                    <div class="border-top pt-15">
                        <h4 class="section-heading">环境变量列表</h4>
                        <div id="variablesList" class="key-value-list"></div>
                        <button class="btn btn-secondary btn-small" onclick="addVariable()">➕ 添加变量</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveVariables()">💾 保存</button>
                    <button class="btn btn-secondary" onclick="closeVariablesModal()">取消</button>
                </div>
            </div>
        </div>
        
        <!-- 新建环境弹窗 -->
        <div id="addEnvironmentModal" class="modal">
            <div class="modal-content modal-medium">
                <div class="modal-header">
                    <h2>➕ 新建环境</h2>
                    <button class="modal-close" onclick="closeAddEnvironmentDialog()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="mb-15">
                        <label class="form-label">环境名称：</label>
                        <input type="text" id="newEnvironmentName" class="auth-input" placeholder="例如：开发环境、测试环境、生产环境" onkeypress="if(event.key==='Enter') addNewEnvironment()">
                    </div>
                    <div class="mb-15">
                        <label class="form-label">快速创建常用环境：</label>
                        <div class="quick-env-buttons">
                            <button class="btn btn-secondary btn-small" onclick="document.getElementById('newEnvironmentName').value='开发环境'; document.getElementById('newEnvironmentName').focus();">开发环境</button>
                            <button class="btn btn-secondary btn-small" onclick="document.getElementById('newEnvironmentName').value='测试环境'; document.getElementById('newEnvironmentName').focus();">测试环境</button>
                            <button class="btn btn-secondary btn-small" onclick="document.getElementById('newEnvironmentName').value='预发布环境'; document.getElementById('newEnvironmentName').focus();">预发布环境</button>
                            <button class="btn btn-secondary btn-small" onclick="document.getElementById('newEnvironmentName').value='生产环境'; document.getElementById('newEnvironmentName').focus();">生产环境</button>
                        </div>
                    </div>
                    <div class="info-box">
                        <p>💡 提示：环境名称将用于区分不同的变量配置，建议使用有意义的名称。</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="addNewEnvironment()">✓ 创建</button>
                    <button class="btn btn-secondary" onclick="closeAddEnvironmentDialog()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentBodyType = 'none';
        let paramsCount = 0;
        let pathVarsCount = 0;
        let headersCount = 0;
        let formDataCount = 0;
        let variablesCount = 0;
        
        // Protobuf 相关变量
        let protobufRoot = null;
        let protobufMessageType = null;
        let isLoadingHistory = false; // 标志位：是否正在加载历史记录
        let globalVariables = {}; // 全局变量存储
        let currentEnvironment = 'default'; // 当前选中的环境
        let environments = {}; // 环境存储：{ envName: { variables: {...} } }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 先初始化基本界面
            addParam();
            addHeader();
            
            // 加载各种配置（顺序很重要）
            loadGlobalVariables();
            loadAuthorizationConfig(); // 加载Authorization配置（必须在initAuthorizationAutoSave之前）
            
            // 加载历史记录
            loadHistory();
            
            // 初始化交互功能
            initVariableHints();
            initAuthorizationAutoSave(); // 初始化Authorization自动保存
            
            // 监听URL变化，鼠标离开时自动检测路径参数和查询参数
            const urlInput = document.getElementById('apiUrl');
            urlInput.addEventListener('blur', function() {
                // 如果正在加载历史记录，不自动解析
                if (isLoadingHistory) return;
                
                autoDetectPathVariables();
                autoDetectQueryParams();
            });
            
            console.log('API测试工具初始化完成');
        });

        // ==================== 全局变量管理 ====================
        
        // 加载全局变量和环境配置
        function loadGlobalVariables() {
            // 加载环境配置
            const storedEnvironments = localStorage.getItem('api_environments');
            if (storedEnvironments) {
                try {
                    environments = JSON.parse(storedEnvironments);
                } catch (e) {
                    environments = {};
                }
            }
            
            // 迁移旧的全局变量数据（兼容旧版本）
            if (Object.keys(environments).length === 0) {
                const oldVariables = localStorage.getItem('api_global_variables');
                if (oldVariables) {
                    try {
                        const oldVars = JSON.parse(oldVariables);
                        environments['default'] = { variables: oldVars };
                        console.log('已迁移旧的全局变量数据到默认环境');
                    } catch (e) {
                        environments['default'] = { variables: {} };
                    }
                } else {
                    environments['default'] = { variables: {} };
                }
            }
            
            // 如果没有任何环境，创建默认环境
            if (Object.keys(environments).length === 0) {
                environments['default'] = { variables: {} };
            }
            
            // 加载当前选中的环境
            const storedCurrentEnv = localStorage.getItem('api_current_environment');
            if (storedCurrentEnv && environments[storedCurrentEnv]) {
                currentEnvironment = storedCurrentEnv;
            } else {
                currentEnvironment = 'default';
            }
            
            // 设置当前环境的全局变量
            globalVariables = environments[currentEnvironment]?.variables || {};
            
            // 更新环境选择器
            updateEnvironmentSelector();
        }

        // 保存全局变量到localStorage
        function saveGlobalVariablesToStorage() {
            // 保存当前环境的变量
            if (!environments[currentEnvironment]) {
                environments[currentEnvironment] = { variables: {} };
            }
            environments[currentEnvironment].variables = globalVariables;
            
            // 保存所有环境配置
            localStorage.setItem('api_environments', JSON.stringify(environments));
            
            // 保存当前选中的环境
            localStorage.setItem('api_current_environment', currentEnvironment);
        }
        
        // 更新环境选择器
        function updateEnvironmentSelector() {
            const mainSelect = document.getElementById('environmentSelect');
            const modalSelect = document.getElementById('modalEnvironmentSelect');
            
            // 生成环境选项HTML
            const optionsHTML = Object.keys(environments).map(envName => {
                const displayName = envName === 'default' ? '默认环境' : envName;
                const varCount = Object.keys(environments[envName]?.variables || {}).length;
                return `<option value="${escapeHtml(envName)}" ${envName === currentEnvironment ? 'selected' : ''}>${escapeHtml(displayName)} (${varCount}个变量)</option>`;
            }).join('');
            
            if (mainSelect) mainSelect.innerHTML = optionsHTML;
            if (modalSelect) modalSelect.innerHTML = optionsHTML;
        }
        
        // 切换环境
        function switchEnvironment() {
            const select = document.getElementById('environmentSelect');
            const newEnv = select.value;
            
            if (newEnv && environments[newEnv]) {
                currentEnvironment = newEnv;
                globalVariables = environments[currentEnvironment].variables || {};
                saveGlobalVariablesToStorage();
                
                // 显示切换提示
                showSuccess(`已切换到环境：${newEnv === 'default' ? '默认环境' : newEnv}`);
            }
        }
        
        // 切换模态框中的环境
        function switchModalEnvironment() {
            const select = document.getElementById('modalEnvironmentSelect');
            const newEnv = select.value;
            
            if (newEnv && environments[newEnv]) {
                currentEnvironment = newEnv;
                globalVariables = environments[currentEnvironment].variables || {};
                
                // 重新加载变量列表
                const variablesList = document.getElementById('variablesList');
                variablesList.innerHTML = '';
                variablesCount = 0;
                
                Object.entries(globalVariables).forEach(([key, value]) => {
                    addVariable(key, value);
                });
                
                // 如果没有变量，添加一个空行
                if (Object.keys(globalVariables).length === 0) {
                    addVariable();
                }
                
                // 同步主选择器
                const mainSelect = document.getElementById('environmentSelect');
                if (mainSelect) mainSelect.value = newEnv;
                
                // 更新删除按钮状态
                updateDeleteEnvButtonState();
            }
        }
        
        // 显示新建环境对话框
        function showAddEnvironmentDialog() {
            document.getElementById('addEnvironmentModal').classList.add('show');
            document.getElementById('newEnvironmentName').value = '';
            document.getElementById('newEnvironmentName').focus();
        }
        
        // 关闭新建环境对话框
        function closeAddEnvironmentDialog() {
            document.getElementById('addEnvironmentModal').classList.remove('show');
        }
        
        // 添加新环境
        function addNewEnvironment() {
            const nameInput = document.getElementById('newEnvironmentName');
            const envName = nameInput.value.trim();
            
            if (!envName) {
                showError('请输入环境名称');
                return;
            }
            
            if (environments[envName]) {
                showError('该环境名称已存在');
                return;
            }
            
            // 创建新环境
            environments[envName] = { variables: {} };
            
            // 切换到新环境
            currentEnvironment = envName;
            globalVariables = {};
            
            // 保存到localStorage
            saveGlobalVariablesToStorage();
            
            // 更新选择器
            updateEnvironmentSelector();
            
            // 刷新变量列表
            const variablesList = document.getElementById('variablesList');
            variablesList.innerHTML = '';
            variablesCount = 0;
            addVariable();
            
            // 更新删除按钮状态
            updateDeleteEnvButtonState();
            
            // 关闭对话框
            closeAddEnvironmentDialog();
            
            showSuccess(`环境 "${envName}" 创建成功`);
        }
        
        // 删除当前环境
        function deleteCurrentEnvironment() {
            if (currentEnvironment === 'default') {
                showError('默认环境不能删除');
                return;
            }
            
            if (!confirm(`确定要删除环境 "${currentEnvironment}" 吗？此操作将删除该环境下的所有变量配置。`)) {
                return;
            }
            
            // 删除环境
            delete environments[currentEnvironment];
            
            // 切换到默认环境
            currentEnvironment = 'default';
            globalVariables = environments['default'].variables || {};
            
            // 保存到localStorage
            saveGlobalVariablesToStorage();
            
            // 更新选择器
            updateEnvironmentSelector();
            
            // 刷新变量列表
            const variablesList = document.getElementById('variablesList');
            variablesList.innerHTML = '';
            variablesCount = 0;
            
            Object.entries(globalVariables).forEach(([key, value]) => {
                addVariable(key, value);
            });
            
            if (Object.keys(globalVariables).length === 0) {
                addVariable();
            }
            
            // 更新删除按钮状态
            updateDeleteEnvButtonState();
            
            showSuccess('环境删除成功');
        }
        
        // 更新删除环境按钮状态
        function updateDeleteEnvButtonState() {
            const deleteBtn = document.getElementById('deleteEnvBtn');
            if (deleteBtn) {
                deleteBtn.disabled = currentEnvironment === 'default';
                if (currentEnvironment === 'default') {
                    deleteBtn.classList.add('btn-disabled-visual');
                } else {
                    deleteBtn.classList.remove('btn-disabled-visual');
                }
            }
        }

        // 打开变量管理弹窗
        function openVariablesModal() {
            const modal = document.getElementById('variablesModal');
            modal.classList.add('show');
            
            // 更新环境选择器
            updateEnvironmentSelector();
            
            // 加载变量到列表
            const variablesList = document.getElementById('variablesList');
            variablesList.innerHTML = '';
            variablesCount = 0;
            
            Object.entries(globalVariables).forEach(([key, value]) => {
                addVariable(key, value);
            });
            
            // 如果没有变量，添加一个空行
            if (Object.keys(globalVariables).length === 0) {
                addVariable();
            }
            
            // 更新删除环境按钮状态
            updateDeleteEnvButtonState();
        }

        // 关闭变量管理弹窗
        function closeVariablesModal() {
            const modal = document.getElementById('variablesModal');
            modal.classList.remove('show');
        }

        // 添加变量行
        function addVariable(key = '', value = '') {
            const id = variablesCount++;
            const html = `
                <div class="key-value-row" id="variable-${id}">
                    <input type="text" class="key-input" placeholder="变量名" value="${escapeHtml(key)}">
                    <input type="text" class="value-input" placeholder="变量值" value="${escapeHtml(value)}">
                    <button class="delete-btn" onclick="deleteRow('variable-${id}')">删除</button>
                </div>
            `;
            document.getElementById('variablesList').insertAdjacentHTML('beforeend', html);
        }

        // 保存变量
        function saveVariables() {
            const variablesList = document.getElementById('variablesList');
            const rows = variablesList.querySelectorAll('.key-value-row');
            const newVariables = {};
            
            rows.forEach(row => {
                const keyInput = row.querySelector('.key-input');
                const valueInput = row.querySelector('.value-input');
                const key = keyInput ? keyInput.value.trim() : '';
                const value = valueInput ? valueInput.value.trim() : '';
                
                if (key) {
                    newVariables[key] = value;
                }
            });
            
            globalVariables = newVariables;
            saveGlobalVariablesToStorage();
            
            // 更新环境选择器以显示最新的变量数量
            updateEnvironmentSelector();
            
            closeVariablesModal();
            
            showSuccess('变量保存成功');
        }

        // 替换文本中的变量
        function replaceVariables(text) {
            if (!text) return text;
            
            // 匹配 {{variableName}} 格式
            return text.replace(/\{\{([^}]+)\}\}/g, (match, varName) => {
                const trimmedName = varName.trim();
                if (globalVariables.hasOwnProperty(trimmedName)) {
                    return globalVariables[trimmedName];
                }
                return match; // 如果变量不存在，保持原样
            });
        }

        // 初始化变量提示功能
        function initVariableHints() {
            // 为所有文本输入框添加变量提示
            const inputSelectors = [
                '#apiUrl',
                '.key-input',
                '.value-input',
                '#bearerToken',
                '#basicUsername',
                '#basicPassword',
                '#apiKeyName',
                '#apiKeyValue',
                '#oauth2Token',
                '#oauth2TokenType',
                '#jsonBody',
                '#textBody'
            ];
            
            // 使用事件委托来处理动态添加的输入框
            document.addEventListener('input', function(e) {
                const target = e.target;
                
                // 检查是否是相关的输入框
                const isRelevantInput = inputSelectors.some(selector => {
                    if (selector.startsWith('#')) {
                        return target.id === selector.substring(1);
                    } else {
                        return target.classList.contains(selector.substring(1));
                    }
                });
                
                if (isRelevantInput) {
                    handleVariableHint(target);
                }
            });
        }

        // 处理变量提示
        function handleVariableHint(input) {
            const value = input.value;
            const cursorPos = input.selectionStart;
            
            // 查找最近的 {{ 位置
            const textBeforeCursor = value.substring(0, cursorPos);
            const lastBracePos = textBeforeCursor.lastIndexOf('{{');
            
            if (lastBracePos !== -1) {
                // 检查在 {{ 之后是否有 }}
                const textAfterBrace = textBeforeCursor.substring(lastBracePos + 2);
                const hasClosingBrace = textAfterBrace.indexOf('}}') !== -1;
                
                if (!hasClosingBrace) {
                    // 显示变量提示
                    const searchTerm = textAfterBrace.toLowerCase();
                    showVariableHints(input, searchTerm);
                    return;
                }
            }
            
            // 隐藏提示
            hideVariableHints();
        }

        // 显示变量提示
        function showVariableHints(input, searchTerm) {
            const variables = Object.keys(globalVariables).filter(key =>
                key.toLowerCase().includes(searchTerm)
            );
            
            if (variables.length === 0) {
                hideVariableHints();
                return;
            }
            
            // 创建或获取提示框
            let hintBox = document.getElementById('variableHintBox');
            if (!hintBox) {
                hintBox = document.createElement('div');
                hintBox.id = 'variableHintBox';
                hintBox.className = 'variable-hint';
                document.body.appendChild(hintBox);
            }
            
            // 填充提示内容
            hintBox.innerHTML = variables.map(key => `
                <div class="variable-hint-item" onclick="insertVariable('${key}')">
                    <span class="variable-hint-key">${escapeHtml(key)}</span>
                    <span class="variable-hint-value">${escapeHtml(globalVariables[key])}</span>
                </div>
            `).join('');
            
            // 定位提示框
            const rect = input.getBoundingClientRect();
            hintBox.style.position = 'fixed';
            hintBox.style.left = rect.left + 'px';
            hintBox.style.top = (rect.bottom + 5) + 'px';
            hintBox.classList.add('show');
            
            // 保存当前输入框的引用
            hintBox.dataset.targetInput = input.id || input.className;
            window.currentHintInput = input;
        }

        // 隐藏变量提示
        function hideVariableHints() {
            const hintBox = document.getElementById('variableHintBox');
            if (hintBox) {
                hintBox.classList.remove('show');
            }
        }

        // 插入变量
        function insertVariable(varName) {
            const input = window.currentHintInput;
            if (!input) {
                hideVariableHints();
                return;
            }
            
            const value = input.value;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = value.substring(0, cursorPos);
            const textAfterCursor = value.substring(cursorPos);
            
            // 查找最近的 {{ 位置
            const lastBracePos = textBeforeCursor.lastIndexOf('{{');
            
            if (lastBracePos !== -1) {
                const newValue = 
                    value.substring(0, lastBracePos) +
                    '{{' + varName + '}}' +
                    textAfterCursor;
                
                input.value = newValue;
                const newCursorPos = lastBracePos + varName.length + 4; // {{varName}}
                input.setSelectionRange(newCursorPos, newCursorPos);
                input.focus();
            }
            
            hideVariableHints();
        }

        // 点击其他地方隐藏提示
        document.addEventListener('click', function(e) {
            const hintBox = document.getElementById('variableHintBox');
            if (hintBox && !hintBox.contains(e.target)) {
                hideVariableHints();
            }
        });

        // 点击弹窗外部关闭弹窗
        document.getElementById('variablesModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVariablesModal();
            }
        });

        // 切换请求标签页
        function switchRequestTab(tabName) {
            document.querySelectorAll('#params, #pathVars, #authorization, #headers, #body, #response').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // 切换认证类型
        function switchAuthType() {
            const authType = document.getElementById('authType').value;
            
            document.querySelectorAll('.auth-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });

            const contentMap = {
                'none': 'authNone',
                'bearer': 'authBearer',
                'basic': 'authBasic',
                'apikey': 'authApiKey',
                'digest': 'authDigest',
                'oauth2': 'authOAuth2'
            };

            const targetContent = document.getElementById(contentMap[authType]);
            if (targetContent) {
                targetContent.classList.add('active');
                targetContent.style.display = 'block';
            }
            
            // 切换认证类型时也保存配置
            saveAuthorizationConfig();
        }

        // ==================== Authorization 缓存管理 ====================
        
        // 保存Authorization配置到localStorage
        function saveAuthorizationConfig() {
            // 如果正在加载历史记录，不自动保存
            if (isLoadingHistory) {
                console.log('⏸️ 正在加载历史记录，跳过Authorization保存');
                return;
            }
            
            try {
                const authConfig = {
                    type: document.getElementById('authType').value,
                    bearerToken: document.getElementById('bearerToken').value,
                    basicUsername: document.getElementById('basicUsername').value,
                    basicPassword: document.getElementById('basicPassword').value,
                    apiKeyName: document.getElementById('apiKeyName').value,
                    apiKeyValue: document.getElementById('apiKeyValue').value,
                    apiKeyLocation: document.getElementById('apiKeyLocation').value,
                    oauth2Token: document.getElementById('oauth2Token').value,
                    oauth2TokenType: document.getElementById('oauth2TokenType').value,
                    digestUsername: document.getElementById('digestUsername').value,
                    digestPassword: document.getElementById('digestPassword').value,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('api_test_authorization', JSON.stringify(authConfig));
                console.log('💾 Authorization配置已保存 (类型:', authConfig.type + ')');
            } catch (error) {
                console.warn('❌ 保存Authorization配置失败:', error);
            }
        }
        
        // 从localStorage加载Authorization配置
        function loadAuthorizationConfig() {
            try {
                const savedConfig = localStorage.getItem('api_test_authorization');
                if (!savedConfig) {
                    console.log('📭 未找到缓存的Authorization配置');
                    return;
                }
                
                const authConfig = JSON.parse(savedConfig);
                console.log('📦 找到缓存的Authorization配置:', authConfig);
                
                // 暂时关闭自动保存标志
                const wasLoadingHistory = isLoadingHistory;
                isLoadingHistory = true;
                
                // 恢复认证类型
                const authTypeElement = document.getElementById('authType');
                if (authTypeElement) {
                    authTypeElement.value = authConfig.type || 'none';
                    console.log('✓ 认证类型已恢复:', authConfig.type);
                }
                
                // 恢复各种认证方式的配置
                const bearerTokenElement = document.getElementById('bearerToken');
                if (bearerTokenElement) bearerTokenElement.value = authConfig.bearerToken || '';
                
                const basicUsernameElement = document.getElementById('basicUsername');
                if (basicUsernameElement) basicUsernameElement.value = authConfig.basicUsername || '';
                
                const basicPasswordElement = document.getElementById('basicPassword');
                if (basicPasswordElement) basicPasswordElement.value = authConfig.basicPassword || '';
                
                const apiKeyNameElement = document.getElementById('apiKeyName');
                if (apiKeyNameElement) apiKeyNameElement.value = authConfig.apiKeyName || '';
                
                const apiKeyValueElement = document.getElementById('apiKeyValue');
                if (apiKeyValueElement) apiKeyValueElement.value = authConfig.apiKeyValue || '';
                
                const apiKeyLocationElement = document.getElementById('apiKeyLocation');
                if (apiKeyLocationElement) apiKeyLocationElement.value = authConfig.apiKeyLocation || 'header';
                
                const oauth2TokenElement = document.getElementById('oauth2Token');
                if (oauth2TokenElement) oauth2TokenElement.value = authConfig.oauth2Token || '';
                
                const oauth2TokenTypeElement = document.getElementById('oauth2TokenType');
                if (oauth2TokenTypeElement) oauth2TokenTypeElement.value = authConfig.oauth2TokenType || 'Bearer';
                
                const digestUsernameElement = document.getElementById('digestUsername');
                if (digestUsernameElement) digestUsernameElement.value = authConfig.digestUsername || '';
                
                const digestPasswordElement = document.getElementById('digestPassword');
                if (digestPasswordElement) digestPasswordElement.value = authConfig.digestPassword || '';
                
                // 切换到对应的认证类型显示（不触发保存）
                const authType = authTypeElement ? authTypeElement.value : 'none';
                document.querySelectorAll('.auth-content').forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });
                const contentMap = {
                    'none': 'authNone',
                    'bearer': 'authBearer',
                    'basic': 'authBasic',
                    'apikey': 'authApiKey',
                    'digest': 'authDigest',
                    'oauth2': 'authOAuth2'
                };
                const targetContent = document.getElementById(contentMap[authType]);
                if (targetContent) {
                    targetContent.classList.add('active');
                    targetContent.style.display = 'block';
                    console.log('✓ 认证类型UI已切换:', authType);
                }
                
                // 恢复原来的标志状态
                setTimeout(() => {
                    isLoadingHistory = wasLoadingHistory;
                }, 100);
                
                console.log('✅ Authorization配置已完全恢复');
            } catch (error) {
                console.error('❌ 加载Authorization配置失败:', error);
            }
        }
        
        // 初始化Authorization自动保存
        function initAuthorizationAutoSave() {
            // 为所有Authorization相关的输入框添加change和input事件
            const authInputIds = [
                'authType',
                'bearerToken',
                'basicUsername',
                'basicPassword',
                'apiKeyName',
                'apiKeyValue',
                'apiKeyLocation',
                'oauth2Token',
                'oauth2TokenType',
                'digestUsername',
                'digestPassword'
            ];
            
            let boundCount = 0;
            authInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // 使用防抖，避免频繁保存
                    let saveTimer;
                    const autoSave = () => {
                        clearTimeout(saveTimer);
                        saveTimer = setTimeout(() => {
                            saveAuthorizationConfig();
                        }, 500); // 500ms后保存
                    };
                    
                    element.addEventListener('input', autoSave);
                    element.addEventListener('change', autoSave);
                    boundCount++;
                }
            });
            
            console.log(`✅ Authorization自动保存已初始化 (绑定了 ${boundCount} 个输入框)`);
        }
        
        // 清除Authorization缓存
        function clearAuthorizationCache() {
            try {
                localStorage.removeItem('api_test_authorization');
                console.log('🗑️ Authorization缓存已清除');
            } catch (error) {
                console.warn('❌ 清除Authorization缓存失败:', error);
            }
        }

        // 切换响应标签页
        function switchResponseTab(tabName) {
            document.querySelectorAll('#responseBody, #requestHeaders, #responseHeaders').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabs = document.querySelector('#responseSection .tabs').children;
            Array.from(tabs).forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // 切换Body类型
        function switchBodyType(type) {
            currentBodyType = type;
            
            document.querySelectorAll('.body-type-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.body-content').forEach(content => {
                content.style.display = 'none';
            });

            const contentMap = {
                'none': 'bodyNone',
                'json': 'bodyJson',
                'form': 'bodyForm',
                'text': 'bodyText',
                'protobuf': 'bodyProtobuf'
            };

            document.getElementById(contentMap[type]).style.display = 'block';

            // 如果是form类型且没有字段，添加一个
            if (type === 'form' && formDataCount === 0) {
                addFormData();
            }
        }

        // 添加Query参数
        function addParam() {
            const id = paramsCount++;
            const html = `
                <div class="key-value-row" id="param-${id}">
                    <input type="checkbox" checked>
                    <input type="text" class="key-input" placeholder="参数名">
                    <input type="text" class="value-input" placeholder="参数值">
                    <button class="delete-btn" onclick="deleteRow('param-${id}')">删除</button>
                </div>
            `;
            document.getElementById('paramsList').insertAdjacentHTML('beforeend', html);
        }

        // 添加Path Variable
        function addPathVar(varName = '', varValue = '') {
            const id = pathVarsCount++;
            const html = `
                <div class="key-value-row" id="pathvar-${id}">
                    <input type="checkbox" checked>
                    <input type="text" class="key-input" placeholder="变量名" value="${varName}">
                    <input type="text" class="value-input" placeholder="变量值" value="${varValue}">
                    <button class="delete-btn" onclick="deleteRow('pathvar-${id}')">删除</button>
                </div>
            `;
            document.getElementById('pathVarsList').insertAdjacentHTML('beforeend', html);
        }

        // 自动检测URL中的路径参数
        function autoDetectPathVariables() {
            const url = document.getElementById('apiUrl').value;
            const pathVarsList = document.getElementById('pathVarsList');
            
            // 如果URL为空，清空路径变量列表
            if (!url) {
                pathVarsList.innerHTML = '';
                pathVarsCount = 0;
                return;
            }

            // 匹配 {variable} 或 :variable 格式
            // 注意：排除 {{variable}} 格式（全局变量）
            const curlyBracePattern = /(?<!\{)\{([^}]+)\}(?!\})/g;  // {variable} 但不是 {{variable}}
            const colonPattern = /:([a-zA-Z_][a-zA-Z0-9_]*)/g;
            
            const detectedVars = new Set();
            
            // 检测 {variable} 格式（排除全局变量 {{variable}}）
            let match;
            while ((match = curlyBracePattern.exec(url)) !== null) {
                detectedVars.add(match[1]);
            }
            
            // 检测 :variable 格式
            while ((match = colonPattern.exec(url)) !== null) {
                detectedVars.add(match[1]);
            }

            // 获取当前已有的变量
            const existingVars = new Set();
            const rows = pathVarsList.querySelectorAll('.key-value-row');
            rows.forEach(row => {
                const keyInput = row.querySelector('.key-input');
                if (keyInput && keyInput.value.trim()) {
                    existingVars.add(keyInput.value.trim());
                }
            });

            // 添加新检测到的变量
            detectedVars.forEach(varName => {
                if (!existingVars.has(varName)) {
                    addPathVar(varName, '');
                }
            });

            // 如果检测到路径参数，自动切换到Path Variables标签
            if (detectedVars.size > 0 && pathVarsList.querySelectorAll('.key-value-row').length > 0) {
                // 不自动切换，只在控制台提示
                // console.log('检测到路径参数:', Array.from(detectedVars));
            }
        }

        // 自动检测URL中的查询参数
        function autoDetectQueryParams() {
            const url = document.getElementById('apiUrl').value.trim();
            const paramsList = document.getElementById('paramsList');
            
            // 如果URL为空，清空参数列表
            if (!url) {
                paramsList.innerHTML = '';
                paramsCount = 0;
                addParam(); // 添加一个空行
                return;
            }

            // 直接查找 ? 后面的参数，不验证URL是否合法
            const questionMarkIndex = url.indexOf('?');
            if (questionMarkIndex === -1) {
                // 没有查询参数
                return;
            }

            const queryString = url.substring(questionMarkIndex + 1);
            if (!queryString) {
                // 查询字符串为空
                return;
            }

            // 手动解析查询参数
            const searchParams = new URLSearchParams(queryString);

            // 获取当前已有的参数
            const existingParams = new Map();
            const rows = paramsList.querySelectorAll('.key-value-row');
            rows.forEach(row => {
                const keyInput = row.querySelector('.key-input');
                const valueInput = row.querySelector('.value-input');
                if (keyInput && keyInput.value.trim()) {
                    existingParams.set(keyInput.value.trim(), valueInput ? valueInput.value : '');
                }
            });

            // 检查是否有新的参数需要添加
            let hasNewParams = false;
            const newParams = [];
            
            searchParams.forEach((value, key) => {
                if (!existingParams.has(key)) {
                    newParams.push({ key, value });
                    hasNewParams = true;
                } else if (existingParams.get(key) !== value) {
                    // 如果参数存在但值不同，更新值
                    rows.forEach(row => {
                        const keyInput = row.querySelector('.key-input');
                        const valueInput = row.querySelector('.value-input');
                        if (keyInput && keyInput.value.trim() === key && valueInput) {
                            valueInput.value = value;
                        }
                    });
                }
            });

            // 添加新检测到的参数
            if (hasNewParams) {
                // 清空第一行空参数（如果存在）
                if (rows.length === 1) {
                    const firstRow = rows[0];
                    const keyInput = firstRow.querySelector('.key-input');
                    const valueInput = firstRow.querySelector('.value-input');
                    if (keyInput && valueInput && !keyInput.value.trim() && !valueInput.value.trim()) {
                        // 第一行是空的，移除它
                        firstRow.remove();
                    }
                }

                // 添加新参数
                newParams.forEach(param => {
                    addParam();
                    const lastRow = paramsList.querySelector('.key-value-row:last-child');
                    if (lastRow) {
                        const keyInput = lastRow.querySelector('.key-input');
                        const valueInput = lastRow.querySelector('.value-input');
                        if (keyInput && valueInput) {
                            keyInput.value = param.key;
                            valueInput.value = param.value;
                        }
                    }
                });
            }

            // 从URL中移除query params（只保留基础URL）
            const baseUrl = url.substring(0, questionMarkIndex);
            const urlInput = document.getElementById('apiUrl');
            if (urlInput && searchParams.toString()) {
                urlInput.value = baseUrl;
                console.log('✂️ Query params已从URL中移除并移至参数列表');
            }
        }

        // 常见的Header配置
        const commonHeaders = {
            'Content-Type': [
                'application/json',
                'application/xml',
                'application/x-www-form-urlencoded',
                'multipart/form-data',
                'text/plain',
                'text/html',
                'text/xml'
            ],
            'Accept': [
                'application/json',
                'application/xml',
                'text/html',
                'text/plain',
                '*/*'
            ],
            'Authorization': [
                'Bearer <token>',
                'Basic <credentials>',
                'API-Key <key>'
            ],
            'User-Agent': [
                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'PostmanRuntime/7.28.0',
                'curl/7.68.0'
            ],
            'Accept-Language': [
                'zh-CN,zh;q=0.9,en;q=0.8',
                'en-US,en;q=0.9',
                'zh-CN'
            ],
            'Accept-Encoding': [
                'gzip, deflate, br',
                'gzip, deflate',
                'identity'
            ],
            'Cache-Control': [
                'no-cache',
                'no-store',
                'max-age=0',
                'must-revalidate'
            ],
            'Connection': [
                'keep-alive',
                'close'
            ],
            'Cookie': [''],
            'Origin': [''],
            'Referer': [''],
            'X-Requested-With': ['XMLHttpRequest'],
            'X-API-Key': [''],
            'X-Auth-Token': ['']
        };

        // 添加Header
        function addHeader() {
            const id = headersCount++;
            const html = `
                <div class="key-value-row" id="header-${id}">
                    <input type="checkbox" checked>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="key-input" placeholder="Header名称" 
                               autocomplete="off"
                               data-header-id="${id}"
                               onfocus="showHeaderSuggestions(${id})"
                               oninput="filterHeaderSuggestions(${id})"
                               onblur="hideHeaderSuggestions(${id}, 200)">
                        <div class="autocomplete-suggestions" id="headerNameSuggestions-${id}"></div>
                    </div>
                    <div class="autocomplete-wrapper wide">
                        <input type="text" class="value-input" placeholder="Header值"
                               autocomplete="off"
                               data-header-id="${id}"
                               onfocus="showHeaderValueSuggestions(${id})"
                               oninput="filterHeaderValueSuggestions(${id})"
                               onblur="hideHeaderValueSuggestions(${id}, 200)">
                        <div class="autocomplete-suggestions" id="headerValueSuggestions-${id}"></div>
                    </div>
                    <button class="delete-btn" onclick="deleteRow('header-${id}')">删除</button>
                </div>
            `;
            document.getElementById('headersList').insertAdjacentHTML('beforeend', html);
        }

        // 显示Header名称建议
        function showHeaderSuggestions(headerId) {
            const suggestions = document.getElementById(`headerNameSuggestions-${headerId}`);
            if (!suggestions) return;
            
            const headerNames = Object.keys(commonHeaders);
            suggestions.innerHTML = headerNames
                .map(name => `<div class="autocomplete-suggestion" onclick="selectHeaderName(${headerId}, '${name}')">${name}</div>`)
                .join('');
            suggestions.classList.add('show');
        }

        // 过滤Header名称建议
        function filterHeaderSuggestions(headerId) {
            const row = document.getElementById(`header-${headerId}`);
            if (!row) return;
            
            const input = row.querySelector('.key-input');
            const suggestions = document.getElementById(`headerNameSuggestions-${headerId}`);
            if (!input || !suggestions) return;
            
            const filter = input.value.toLowerCase();
            const headerNames = Object.keys(commonHeaders).filter(name => 
                name.toLowerCase().includes(filter)
            );
            
            if (headerNames.length > 0 && filter) {
                suggestions.innerHTML = headerNames
                    .map(name => `<div class="autocomplete-suggestion" onclick="selectHeaderName(${headerId}, '${name}')">${name}</div>`)
                    .join('');
                suggestions.classList.add('show');
            } else if (filter) {
                suggestions.classList.remove('show');
            } else {
                showHeaderSuggestions(headerId);
            }
        }

        // 隐藏Header名称建议
        function hideHeaderSuggestions(headerId, delay = 0) {
            setTimeout(() => {
                const suggestions = document.getElementById(`headerNameSuggestions-${headerId}`);
                if (suggestions) {
                    suggestions.classList.remove('show');
                }
            }, delay);
        }

        // 选择Header名称
        function selectHeaderName(headerId, name) {
            const row = document.getElementById(`header-${headerId}`);
            if (!row) return;
            
            const input = row.querySelector('.key-input');
            if (input) {
                input.value = name;
                hideHeaderSuggestions(headerId);
                // 自动显示对应的值建议
                setTimeout(() => {
                    const valueInput = row.querySelector('.value-input');
                    if (valueInput) {
                        valueInput.focus();
                        showHeaderValueSuggestions(headerId);
                    }
                }, 100);
            }
        }

        // 显示Header值建议
        function showHeaderValueSuggestions(headerId) {
            const row = document.getElementById(`header-${headerId}`);
            if (!row) return;
            
            const keyInput = row.querySelector('.key-input');
            const suggestions = document.getElementById(`headerValueSuggestions-${headerId}`);
            if (!keyInput || !suggestions) return;
            
            const headerName = keyInput.value.trim();
            
            if (commonHeaders[headerName] && commonHeaders[headerName].length > 0) {
                suggestions.innerHTML = commonHeaders[headerName]
                    .map(value => {
                        const escapedValue = value.replace(/'/g, "\\'");
                        return `<div class="autocomplete-suggestion" onclick="selectHeaderValue(${headerId}, '${escapedValue}')">${value}</div>`;
                    })
                    .join('');
                suggestions.classList.add('show');
            } else {
                suggestions.classList.remove('show');
            }
        }

        // 过滤Header值建议
        function filterHeaderValueSuggestions(headerId) {
            const row = document.getElementById(`header-${headerId}`);
            if (!row) return;
            
            const keyInput = row.querySelector('.key-input');
            const valueInput = row.querySelector('.value-input');
            const suggestions = document.getElementById(`headerValueSuggestions-${headerId}`);
            if (!keyInput || !valueInput || !suggestions) return;
            
            const headerName = keyInput.value.trim();
            const filter = valueInput.value.toLowerCase();
            
            if (commonHeaders[headerName]) {
                const filteredValues = commonHeaders[headerName].filter(value =>
                    value.toLowerCase().includes(filter)
                );
                
                if (filteredValues.length > 0 && filter) {
                    suggestions.innerHTML = filteredValues
                        .map(value => {
                            const escapedValue = value.replace(/'/g, "\\'");
                            return `<div class="autocomplete-suggestion" onclick="selectHeaderValue(${headerId}, '${escapedValue}')">${value}</div>`;
                        })
                        .join('');
                    suggestions.classList.add('show');
                } else if (!filter) {
                    showHeaderValueSuggestions(headerId);
                } else {
                    suggestions.classList.remove('show');
                }
            }
        }

        // 隐藏Header值建议
        function hideHeaderValueSuggestions(headerId, delay = 0) {
            setTimeout(() => {
                const suggestions = document.getElementById(`headerValueSuggestions-${headerId}`);
                if (suggestions) {
                    suggestions.classList.remove('show');
                }
            }, delay);
        }

        // 选择Header值
        function selectHeaderValue(headerId, value) {
            const row = document.getElementById(`header-${headerId}`);
            if (!row) return;
            
            const input = row.querySelector('.value-input');
            if (input) {
                input.value = value;
                hideHeaderValueSuggestions(headerId);
            }
        }

        // 添加Form Data
        function addFormData() {
            const id = formDataCount++;
            const html = `
                <div class="key-value-row" id="formdata-${id}">
                    <input type="checkbox" checked>
                    <input type="text" class="key-input" placeholder="字段名">
                    <input type="text" class="value-input" placeholder="字段值">
                    <button class="delete-btn" onclick="deleteRow('formdata-${id}')">删除</button>
                </div>
            `;
            document.getElementById('formDataList').insertAdjacentHTML('beforeend', html);
        }

        // 删除行
        function deleteRow(id) {
            document.getElementById(id).remove();
        }

        // 获取键值对数据（仅选中的）
        function getKeyValueData(containerId) {
            const container = document.getElementById(containerId);
            const rows = container.querySelectorAll('.key-value-row');
            const data = {};

            rows.forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const keyInput = row.querySelector('.key-input');
                const valueInput = row.querySelector('.value-input');

                if (checkbox.checked && keyInput.value.trim()) {
                    data[keyInput.value.trim()] = valueInput.value.trim();
                }
            });

            return data;
        }

        // 获取所有键值对数据（包括未选中的）
        function getAllKeyValueData(containerId) {
            const container = document.getElementById(containerId);
            const rows = container.querySelectorAll('.key-value-row');
            const data = [];

            rows.forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const keyInput = row.querySelector('.key-input');
                const valueInput = row.querySelector('.value-input');

                const key = keyInput ? keyInput.value.trim() : '';
                const value = valueInput ? valueInput.value.trim() : '';
                
                if (key || value) { // 只保存有内容的行
                    data.push({
                        enabled: checkbox ? checkbox.checked : true,
                        key: key,
                        value: value
                    });
                }
            });

            return data;
        }

        // 应用认证信息
        function applyAuthorization(headers, urlObj) {
            const authType = document.getElementById('authType').value;

            switch (authType) {
                case 'bearer':
                    const bearerToken = replaceVariables(document.getElementById('bearerToken').value.trim());
                    if (bearerToken) {
                        headers['Authorization'] = `Bearer ${bearerToken}`;
                    }
                    break;

                case 'basic':
                    const basicUsername = replaceVariables(document.getElementById('basicUsername').value);
                    const basicPassword = replaceVariables(document.getElementById('basicPassword').value);
                    if (basicUsername || basicPassword) {
                        const credentials = btoa(`${basicUsername}:${basicPassword}`);
                        headers['Authorization'] = `Basic ${credentials}`;
                    }
                    break;

                case 'apikey':
                    const apiKeyName = replaceVariables(document.getElementById('apiKeyName').value.trim());
                    const apiKeyValue = replaceVariables(document.getElementById('apiKeyValue').value.trim());
                    const apiKeyLocation = document.getElementById('apiKeyLocation').value;
                    
                    if (apiKeyName && apiKeyValue) {
                        if (apiKeyLocation === 'header') {
                            headers[apiKeyName] = apiKeyValue;
                        } else {
                            urlObj.searchParams.append(apiKeyName, apiKeyValue);
                        }
                    }
                    break;

                case 'digest':
                    // Digest Auth在浏览器中需要服务器challenge，暂不完全支持
                    const digestUsername = replaceVariables(document.getElementById('digestUsername').value);
                    const digestPassword = replaceVariables(document.getElementById('digestPassword').value);
                    if (digestUsername) {
                        // 标记使用Digest Auth（实际处理需要服务器配合）
                        console.log('Digest Auth需要服务器返回401 challenge');
                    }
                    break;

                case 'oauth2':
                    const oauth2Token = replaceVariables(document.getElementById('oauth2Token').value.trim());
                    const oauth2TokenType = replaceVariables(document.getElementById('oauth2TokenType').value.trim()) || 'Bearer';
                    if (oauth2Token) {
                        headers['Authorization'] = `${oauth2TokenType} ${oauth2Token}`;
                    }
                    break;

                case 'none':
                default:
                    // 不添加认证信息
                    break;
            }
        }

        // 发送请求
        async function sendRequest() {
            const originalUrl = document.getElementById('apiUrl').value.trim(); // 保存原始URL
            let url = replaceVariables(originalUrl); // 替换全局变量
            const method = document.getElementById('httpMethod').value;

            if (!url) {
                showError('请输入API地址');
                return;
            }

            // 替换路径参数（也要替换路径参数中的变量）
            const pathVars = getKeyValueData('pathVarsList');
            Object.keys(pathVars).forEach(key => {
                const value = replaceVariables(pathVars[key]);
                // 替换 {variable} 格式
                url = url.replace(new RegExp(`\\{${key}\\}`, 'g'), value);
                // 替换 :variable 格式
                url = url.replace(new RegExp(`:${key}\\b`, 'g'), value);
            });

            // 验证URL格式
            try {
                new URL(url);
            } catch (e) {
                showError('请输入有效的URL地址');
                return;
            }

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading-spinner"></span> 发送中...';

            const startTime = Date.now();

            try {
                // 构建完整URL（包含query参数，替换变量）
                const params = getKeyValueData('paramsList');
                const urlObj = new URL(url);
                Object.keys(params).forEach(key => {
                    urlObj.searchParams.append(key, replaceVariables(params[key]));
                });

                // 构建请求头（替换变量）
                const headers = getKeyValueData('headersList');
                const replacedHeaders = {};
                Object.keys(headers).forEach(key => {
                    replacedHeaders[key] = replaceVariables(headers[key]);
                });

                // 应用认证信息
                applyAuthorization(replacedHeaders, urlObj);

                // 构建请求配置
                const fetchOptions = {
                    method: method,
                    headers: replacedHeaders
                };

                // 构建请求体（替换变量）
                if (method !== 'GET' && method !== 'HEAD') {
                    if (currentBodyType === 'json') {
                        const jsonBody = document.getElementById('jsonBody').value.trim();
                        if (jsonBody) {
                            try {
                                const replacedJson = replaceVariables(jsonBody);
                                JSON.parse(replacedJson); // 验证JSON
                                fetchOptions.body = replacedJson;
                                if (!replacedHeaders['Content-Type']) {
                                    fetchOptions.headers['Content-Type'] = 'application/json';
                                }
                            } catch (e) {
                                throw new Error('JSON格式错误：' + e.message);
                            }
                        }
                    } else if (currentBodyType === 'form') {
                        const formData = getKeyValueData('formDataList');
                        const formBody = new URLSearchParams();
                        Object.keys(formData).forEach(key => {
                            formBody.append(key, replaceVariables(formData[key]));
                        });
                        fetchOptions.body = formBody;
                    } else if (currentBodyType === 'text') {
                        const textBody = document.getElementById('textBody').value;
                        if (textBody) {
                            fetchOptions.body = replaceVariables(textBody);
                        }
                    } else if (currentBodyType === 'protobuf') {
                        // Protocol Buffer 编码
                        const protobufBody = await encodeProtobufRequest();
                        if (protobufBody) {
                            fetchOptions.body = protobufBody;
                            if (!replacedHeaders['Content-Type']) {
                                fetchOptions.headers['Content-Type'] = 'application/x-protobuf';
                            }
                        } else {
                            throw new Error('Protobuf 编码失败：请检查 Proto 定义和 JSON 数据');
                        }
                    }
                }

                // 发送请求
                const response = await fetch(urlObj.toString(), fetchOptions);
                const endTime = Date.now();
                const duration = endTime - startTime;

                // 获取响应内容
                const contentType = response.headers.get('content-type');
                let responseBody;
                
                if (contentType && contentType.includes('application/json')) {
                    try {
                        responseBody = await response.json();
                    } catch (e) {
                        // JSON解析失败，作为文本处理
                        responseBody = await response.text();
                    }
                } else if (contentType && (contentType.includes('application/x-protobuf') || contentType.includes('application/protobuf'))) {
                    // Protobuf响应，获取二进制数据
                    const arrayBuffer = await response.arrayBuffer();
                    responseBody = {
                        __isProtobuf: true,
                        data: new Uint8Array(arrayBuffer)
                    };
                } else {
                    responseBody = await response.text();
                }

                // 获取响应头（获取所有HTTP返回的响应头）
                const responseHeaders = {};
                let headerCount = 0;
                
                // 使用forEach遍历所有可访问的响应头
                response.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                    headerCount++;
                });
                
                console.log(`📥 接收到 ${headerCount} 个HTTP响应头:`, responseHeaders);
                
                // 注意：某些响应头（如Set-Cookie）由于浏览器安全策略，无法通过JavaScript访问
                // 如果需要访问自定义响应头，服务器需要设置：Access-Control-Expose-Headers

                // 保存实际发送的请求头（包括浏览器自动添加的）
                const actualRequestHeaders = { ...fetchOptions.headers };
                
                // 显示响应结果（传递请求头信息）
                displayResponse(response.status, duration, responseBody, responseHeaders, contentType, actualRequestHeaders);

                // 保存到历史记录（保存所有参数，包括未选中的）
                const allParams = getAllKeyValueData('paramsList');
                const allPathVars = getAllKeyValueData('pathVarsList');
                const allHeaders = getAllKeyValueData('headersList');
                const allFormData = currentBodyType === 'form' ? getAllKeyValueData('formDataList') : [];
                
                // 获取认证信息
                const authData = {
                    type: document.getElementById('authType').value,
                    bearerToken: document.getElementById('bearerToken').value,
                    basicUsername: document.getElementById('basicUsername').value,
                    basicPassword: document.getElementById('basicPassword').value,
                    apiKeyName: document.getElementById('apiKeyName').value,
                    apiKeyValue: document.getElementById('apiKeyValue').value,
                    apiKeyLocation: document.getElementById('apiKeyLocation').value,
                    oauth2Token: document.getElementById('oauth2Token').value,
                    oauth2TokenType: document.getElementById('oauth2TokenType').value
                };
                
                // 获取Body数据
                const bodyData = {
                    type: currentBodyType,
                    jsonBody: document.getElementById('jsonBody').value,
                    textBody: document.getElementById('textBody').value,
                    formData: allFormData,
                    protobufData: currentBodyType === 'protobuf' ? {
                        protoDefinition: document.getElementById('requestProtoDefinition')?.value || '',
                        messageType: document.getElementById('requestProtoMessageType')?.value || '',
                        jsonInput: document.getElementById('protobufJsonInput')?.value || ''
                    } : null
                };
                
                // 使用原始URL，不使用处理后的URL
                saveToHistory(method, originalUrl, response.status, duration, allParams, allPathVars, allHeaders, authData, bodyData, responseBody, responseHeaders, contentType, actualRequestHeaders);

            } catch (error) {
                showError('请求失败：' + error.message);
                document.getElementById('responseSection').classList.remove('show');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '发送请求';
            }
        }

        // 显示响应结果
        function displayResponse(status, duration, body, responseHeaders, contentType, requestHeaders) {
            const responseSection = document.getElementById('responseSection');
            responseSection.classList.add('show');

            // 显示状态信息
            const statusClass = status >= 200 && status < 300 ? 'success' : 'error';
            document.getElementById('responseStatus').innerHTML = `
                <div class="status-item">
                    <div class="status-label">状态码</div>
                    <div class="status-value ${statusClass}">${status}</div>
                </div>
                <div class="status-item">
                    <div class="status-label">响应时间</div>
                    <div class="status-value">${duration} ms</div>
                </div>
                <div class="status-item">
                    <div class="status-label">响应大小</div>
                    <div class="status-value">${formatBytes(new Blob([typeof body === 'string' ? body : JSON.stringify(body)]).size)}</div>
                </div>
            `;

            // 格式化并显示响应内容
            const responseContentElement = document.getElementById('responseContent');
            const formattedContent = formatResponseBody(body, contentType);
            responseContentElement.innerHTML = formattedContent;

            // 显示请求头（带语法高亮和说明）
            if (requestHeaders) {
                // 计算配置的请求头数量
                const configuredHeaderCount = Object.keys(requestHeaders).length;
                
                // 构建完整的请求头展示
                let requestHeadersDisplay = '<div style="margin-bottom: 15px;">';
                requestHeadersDisplay += '<h4 style="color: #4facfe; margin-bottom: 10px; font-size: 1em;">📤 已配置的请求头</h4>';
                requestHeadersDisplay += `<div style="margin-bottom: 10px; font-size: 0.9em; color: #666;">共 ${configuredHeaderCount} 个自定义请求头</div>`;
                
                if (configuredHeaderCount > 0) {
                    requestHeadersDisplay += syntaxHighlightJSON(JSON.stringify(requestHeaders, null, 2));
                } else {
                    requestHeadersDisplay += '<div style="color: #999; font-style: italic; padding: 10px 0;">未配置自定义请求头</div>';
                }
                requestHeadersDisplay += '</div>';
                
                // 添加浏览器自动添加的常见请求头说明
                requestHeadersDisplay += '<div style="margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 5px;">';
                requestHeadersDisplay += '<h4 style="color: #666; margin-bottom: 10px; font-size: 0.95em;">🌐 浏览器自动添加的常见请求头（仅供参考）</h4>';
                requestHeadersDisplay += '<div style="font-size: 0.85em; color: #666; line-height: 1.8;">';
                requestHeadersDisplay += '• <strong>User-Agent:</strong> 浏览器标识和版本信息<br>';
                requestHeadersDisplay += '• <strong>Accept:</strong> 可接受的响应内容类型（如text/html, application/json）<br>';
                requestHeadersDisplay += '• <strong>Accept-Language:</strong> 可接受的语言（如zh-CN, en-US）<br>';
                requestHeadersDisplay += '• <strong>Accept-Encoding:</strong> 可接受的压缩编码（如gzip, deflate, br）<br>';
                requestHeadersDisplay += '• <strong>Connection:</strong> 连接类型（通常为keep-alive）<br>';
                requestHeadersDisplay += '• <strong>Origin:</strong> 请求来源域名（跨域请求时）<br>';
                requestHeadersDisplay += '• <strong>Referer:</strong> 引用页面的完整URL<br>';
                requestHeadersDisplay += '• <strong>Sec-Fetch-Site/Mode/Dest:</strong> 浏览器安全策略相关的头信息<br>';
                requestHeadersDisplay += '• <strong>Cache-Control:</strong> 缓存控制指令';
                requestHeadersDisplay += '</div>';
                requestHeadersDisplay += '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0; font-size: 0.8em; color: #999; font-style: italic;">';
                requestHeadersDisplay += '💡 <strong>说明：</strong> 上述请求头由浏览器根据HTTP协议和安全策略自动管理和添加，开发者无法通过JavaScript完全控制或获取这些头的实际值。实际发送的请求头数量可能更多。';
                requestHeadersDisplay += '</div>';
                requestHeadersDisplay += '</div>';
                
                document.getElementById('requestHeadersContent').innerHTML = requestHeadersDisplay;
            }

            // 显示响应头（带语法高亮，显示所有HTTP返回的响应头）
            let responseHeadersContent = '<div style="margin-bottom: 15px;">';
            responseHeadersContent += '<h4 style="color: #28a745; margin-bottom: 10px; font-size: 1em;">📥 服务器返回的所有响应头</h4>';
            
            // 计算响应头数量
            const headerCount = Object.keys(responseHeaders).length;
            responseHeadersContent += `<div style="margin-bottom: 10px; font-size: 0.9em; color: #666;">✅ 成功获取 ${headerCount} 个HTTP响应头</div>`;
            
            if (headerCount > 0) {
                responseHeadersContent += syntaxHighlightJSON(JSON.stringify(responseHeaders, null, 2));
            } else {
                responseHeadersContent += '<div style="color: #999; font-style: italic; padding: 10px 0;">未获取到响应头信息</div>';
            }
            responseHeadersContent += '</div>';
            
            // 添加安全策略说明
            responseHeadersContent += '<div style="margin-top: 20px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">';
            responseHeadersContent += '<h4 style="color: #856404; margin-bottom: 10px; font-size: 0.95em;">⚠️ 浏览器安全策略限制</h4>';
            responseHeadersContent += '<div style="font-size: 0.85em; color: #856404; line-height: 1.8;">';
            responseHeadersContent += '<p style="margin: 0 0 10px 0;"><strong>由于浏览器安全策略，以下响应头无法通过JavaScript访问：</strong></p>';
            responseHeadersContent += '• <strong>Set-Cookie / Set-Cookie2:</strong> Cookie设置头（浏览器自动处理）<br>';
            responseHeadersContent += '• <strong>自定义响应头：</strong> 需要服务器设置 <code>Access-Control-Expose-Headers</code><br>';
            responseHeadersContent += '</div>';
            responseHeadersContent += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ffc107; font-size: 0.85em; color: #856404;">';
            responseHeadersContent += '<strong>💡 如何访问自定义响应头：</strong><br>';
            responseHeadersContent += '<div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px; font-family: monospace; font-size: 0.9em;">';
            responseHeadersContent += '服务器需要添加以下响应头：<br>';
            responseHeadersContent += '<code style="color: #d63384;">Access-Control-Expose-Headers: X-Custom-Header, X-Request-ID</code><br>';
            responseHeadersContent += '<span style="font-size: 0.85em; color: #666;">(列出所有需要暴露的自定义头，用逗号分隔)</span>';
            responseHeadersContent += '</div>';
            responseHeadersContent += '<div style="margin-top: 8px; font-size: 0.9em;">';
            responseHeadersContent += '或使用通配符（生产环境不推荐）：<br>';
            responseHeadersContent += '<code style="color: #d63384;">Access-Control-Expose-Headers: *</code>';
            responseHeadersContent += '</div>';
            responseHeadersContent += '</div>';
            responseHeadersContent += '</div>';
            
            // 常见的响应头说明
            responseHeadersContent += '<div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 5px;">';
            responseHeadersContent += '<h4 style="color: #1976D2; margin-bottom: 10px; font-size: 0.95em;">📚 常见HTTP响应头说明</h4>';
            responseHeadersContent += '<div style="font-size: 0.85em; color: #1976D2; line-height: 1.8;">';
            responseHeadersContent += '• <strong>content-type:</strong> 响应内容的媒体类型<br>';
            responseHeadersContent += '• <strong>content-length:</strong> 响应内容的字节大小<br>';
            responseHeadersContent += '• <strong>date:</strong> 响应生成的日期和时间<br>';
            responseHeadersContent += '• <strong>server:</strong> 服务器软件信息<br>';
            responseHeadersContent += '• <strong>cache-control:</strong> 缓存控制指令<br>';
            responseHeadersContent += '• <strong>etag:</strong> 资源的特定版本标识符<br>';
            responseHeadersContent += '• <strong>access-control-*:</strong> CORS跨域相关头<br>';
            responseHeadersContent += '• <strong>x-*:</strong> 通常为自定义响应头（需CORS配置）';
            responseHeadersContent += '</div>';
            responseHeadersContent += '</div>';
            
            document.getElementById('responseHeadersContent').innerHTML = responseHeadersContent;

            // 滚动到响应区域
            responseSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // 格式化响应体
        function formatResponseBody(body, contentType) {
            if (!body) return '<span style="color: #999;">无响应内容</span>';

            try {
                // Protobuf格式
                if (body.__isProtobuf) {
                    return formatProtobufResponse(body.data);
                }

                // JSON格式
                if (contentType && contentType.includes('application/json')) {
                    const jsonObj = typeof body === 'string' ? JSON.parse(body) : body;
                    const formattedJson = JSON.stringify(jsonObj, null, 2);
                    return syntaxHighlightJSON(formattedJson);
                }

                // XML格式
                if (contentType && (contentType.includes('application/xml') || contentType.includes('text/xml'))) {
                    return syntaxHighlightXML(formatXML(body));
                }

                // HTML格式
                if (contentType && contentType.includes('text/html')) {
                    return syntaxHighlightHTML(body);
                }

                // 尝试自动检测JSON
                if (typeof body === 'string' && (body.trim().startsWith('{') || body.trim().startsWith('['))) {
                    try {
                        const jsonObj = JSON.parse(body);
                        const formattedJson = JSON.stringify(jsonObj, null, 2);
                        return syntaxHighlightJSON(formattedJson);
                    } catch (e) {
                        // 不是有效的JSON，继续作为纯文本处理
                    }
                }

                // 纯文本
                return `<pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(body)}</pre>`;
            } catch (e) {
                return `<pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(String(body))}</pre>`;
            }
        }

        // 格式化Protobuf响应
        function formatProtobufResponse(uint8Array) {
            let result = '<div style="margin-bottom: 20px;">';
            
            // 显示原始数据信息
            result += '<div style="background: #fff9e6; border-left: 4px solid #ffc107; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
            result += '<strong>📦 Protocol Buffer 响应</strong><br>';
            result += `数据大小: ${uint8Array.length} 字节<br>`;
            
            // 如果有proto定义，尝试解码
            if (protobufRoot && protobufMessageType) {
                result += `使用消息类型: <span style="color: #2196F3;">${protobufMessageType}</span>`;
                result += '</div>';
                
                try {
                    const MessageType = protobufRoot.lookupType(protobufMessageType);
                    const message = MessageType.decode(uint8Array);
                    // 保持数据类型与proto定义一致：不转换long/enum/bytes
                    const jsonResult = MessageType.toObject(message, {
                        longs: Number,      // int64保持为Number类型
                        enums: Number,      // enum保持为Number类型
                        bytes: Array,       // bytes保持为Array类型
                        defaults: false,    // 不填充默认值，只返回实际存在的字段
                        arrays: true,       // 保留数组
                        objects: true,      // 保留对象
                        oneofs: true        // 包含oneof字段
                    });
                    
                    // 格式化的JSON字符串
                    const formattedJson = JSON.stringify(jsonResult, null, 2);
                    
                    result += '<div style="margin-bottom: 15px;">';
                    result += '<h4 style="color: #28a745; margin-bottom: 10px;">✅ 解码成功 (JSON格式)</h4>';
                    result += '<div style="background: #e7f3ff; border-left: 3px solid #2196F3; padding: 8px 12px; margin-bottom: 10px; border-radius: 4px; font-size: 0.85em;">';
                    result += '<strong>💡 提示：</strong> 点击"📋 复制"按钮将只复制解码后的JSON内容，不包括下方的原始十六进制数据。';
                    result += '</div>';
                    // 使用data-copyable属性标记这是可复制的内容
                    result += '<div class="protobuf-decoded-content" data-copyable="true">';
                    result += syntaxHighlightJSON(formattedJson);
                    result += '</div>';
                    result += '</div>';
                } catch (error) {
                    result += '<div style="background: #fff5f5; border-left: 4px solid #fc8181; padding: 10px; margin-bottom: 15px; border-radius: 4px;">';
                    result += '<strong style="color: #c53030;">❌ 解码失败</strong><br>';
                    result += `错误信息: ${escapeHtml(error.message)}`;
                    result += '</div>';
                }
            } else {
                result += '<br>⚠️ 未配置 Proto 定义，无法自动解码';
                result += '</div>';
            }
            
            // 显示十六进制数据（不可复制）
            result += '<div style="margin-top: 15px;" class="protobuf-raw-content" data-copyable="false">';
            result += '<h4 style="color: #666; margin-bottom: 10px;">原始数据 (Hex) - 仅供查看</h4>';
            result += '<pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: monospace; font-size: 0.9em;">';
            
            // 格式化十六进制输出，每16个字节一行
            for (let i = 0; i < uint8Array.length; i += 16) {
                const offset = i.toString(16).padStart(8, '0');
                const bytes = Array.from(uint8Array.slice(i, i + 16))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(' ');
                const ascii = Array.from(uint8Array.slice(i, i + 16))
                    .map(b => (b >= 32 && b <= 126) ? String.fromCharCode(b) : '.')
                    .join('');
                result += `<span style="color: #999;">${offset}</span>  ${bytes.padEnd(48, ' ')}  <span style="color: #666;">${escapeHtml(ascii)}</span>\n`;
            }
            
            result += '</pre></div>';
            result += '</div>';
            
            return result;
        }

        // JSON语法高亮
        function syntaxHighlightJSON(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return '<pre style="margin: 0;">' + json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            }) + '</pre>';
        }

        // XML格式化
        function formatXML(xml) {
            const PADDING = '  ';
            const reg = /(>)(<)(\/*)/g;
            let pad = 0;
            xml = xml.replace(reg, '$1\r\n$2$3');
            return xml.split('\r\n').map((node) => {
                let indent = 0;
                if (node.match(/.+<\/\w[^>]*>$/)) {
                    indent = 0;
                } else if (node.match(/^<\/\w/)) {
                    if (pad !== 0) {
                        pad -= 1;
                    }
                } else if (node.match(/^<\w([^>]*[^\/])?>.*$/)) {
                    indent = 1;
                } else {
                    indent = 0;
                }
                const padding = PADDING.repeat(pad);
                pad += indent;
                return padding + node;
            }).join('\r\n');
        }

        // XML语法高亮
        function syntaxHighlightXML(xml) {
            xml = escapeHtml(xml);
            xml = xml.replace(/(&lt;\/?)([\w-]+)/g, '<span class="xml-tag">$1</span><span class="xml-tag-name">$2</span>');
            xml = xml.replace(/([\w-]+)(=)/g, '<span class="xml-attr">$1</span><span class="xml-punct">$2</span>');
            xml = xml.replace(/(".*?")/g, '<span class="xml-string">$1</span>');
            return '<pre style="margin: 0;">' + xml + '</pre>';
        }

        // HTML语法高亮
        function syntaxHighlightHTML(html) {
            html = escapeHtml(html);
            html = html.replace(/(&lt;\/?)([\w-]+)/g, '<span class="html-tag">$1</span><span class="html-tag-name">$2</span>');
            html = html.replace(/([\w-]+)(=)/g, '<span class="html-attr">$1</span><span class="html-punct">$2</span>');
            html = html.replace(/(".*?")/g, '<span class="html-string">$1</span>');
            html = html.replace(/(&lt;!--.*?--&gt;)/g, '<span class="html-comment">$1</span>');
            return '<pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">' + html + '</pre>';
        }

        // 显示错误
        function showError(message) {
            const responseSection = document.getElementById('responseSection');
            responseSection.classList.add('show');
            document.getElementById('responseStatus').innerHTML = `
                <div class="alert alert-danger">❌ ${message}</div>
            `;
        }

        // 复制响应内容
        function copyResponse(elementId, event) {
            try {
                const element = document.getElementById(elementId);
                if (!element) {
                    alert('❌ 没有可复制的内容');
                    return;
                }
                
                let content = '';
                
                // 检查是否是Protobuf响应（只复制解码后的内容）
                const protobufDecodedContent = element.querySelector('.protobuf-decoded-content[data-copyable="true"]');
                if (protobufDecodedContent) {
                    // 只复制解码后的JSON内容
                    content = protobufDecodedContent.textContent || protobufDecodedContent.innerText || '';
                    console.log('📋 复制Protobuf解码后的内容');
                } else {
                    // 正常复制所有内容
                    content = element.textContent || element.innerText || '';
                }
                
                // 如果内容为空或只是提示信息
                if (!content || content.includes('等待') || content.includes('无响应')) {
                    alert('❌ 没有可复制的内容');
                    return;
                }
                
                navigator.clipboard.writeText(content).then(() => {
                    const button = event ? event.target : document.activeElement;
                    if (button) {
                        const originalText = button.textContent;
                        const originalBg = button.style.background;
                        
                        // 如果是protobuf响应，显示特殊提示
                        if (protobufDecodedContent) {
                            button.textContent = '✅ 已复制解码内容';
                        } else {
                            button.textContent = '✅ 已复制';
                        }
                        button.style.background = '#28a745';
                        
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.style.background = originalBg || '#667eea';
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('复制失败:', err);
                    alert('❌ 复制失败：' + err.message);
                });
            } catch (error) {
                console.error('复制响应内容出错:', error);
                alert('❌ 复制失败：' + error.message);
            }
        }

        // 格式化字节大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // 清空所有
        function clearAll() {
            document.getElementById('apiUrl').value = '';
            document.getElementById('paramsList').innerHTML = '';
            document.getElementById('pathVarsList').innerHTML = '';
            document.getElementById('headersList').innerHTML = '';
            document.getElementById('formDataList').innerHTML = '';
            document.getElementById('jsonBody').value = '';
            document.getElementById('textBody').value = '';
            document.getElementById('responseSection').classList.remove('show');
            
            // 清空认证信息
            document.getElementById('authType').value = 'none';
            document.getElementById('bearerToken').value = '';
            document.getElementById('basicUsername').value = '';
            document.getElementById('basicPassword').value = '';
            document.getElementById('apiKeyName').value = 'X-API-Key';
            document.getElementById('apiKeyValue').value = '';
            document.getElementById('apiKeyLocation').value = 'header';
            document.getElementById('digestUsername').value = '';
            document.getElementById('digestPassword').value = '';
            document.getElementById('oauth2Token').value = '';
            document.getElementById('oauth2TokenType').value = 'Bearer';
            switchAuthType();
            
            // 清除Authorization缓存
            clearAuthorizationCache();
            
            paramsCount = 0;
            pathVarsCount = 0;
            headersCount = 0;
            formDataCount = 0;
            
            addParam();
            addHeader();
        }

        // ==================== 历史记录管理 ====================
        const MAX_HISTORY = 20;

        function saveToHistory(method, url, status, duration, params, pathVars, headers, authData, bodyData, responseBody, responseHeaders, contentType, requestHeaders) {
            const storageKey = 'api_test_history';
            let history = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // 处理响应体，如果是Protobuf二进制数据，转换为可存储的格式
            let serializableResponseBody = responseBody;
            if (responseBody && responseBody.__isProtobuf) {
                serializableResponseBody = {
                    __isProtobuf: true,
                    data: Array.from(responseBody.data) // 将Uint8Array转换为普通数组
                };
            }
            
            const record = {
                id: Date.now(),
                method: method,
                url: url,
                status: status,
                duration: duration,
                params: params,  // 数组格式，包含enabled状态
                pathVars: pathVars,  // 数组格式
                headers: headers,  // 数组格式
                authData: authData,  // 认证信息对象
                bodyData: bodyData,  // Body数据对象
                responseBody: serializableResponseBody,  // 响应体
                responseHeaders: responseHeaders,  // 响应头
                contentType: contentType,  // 响应内容类型
                requestHeaders: requestHeaders,  // 实际请求头
                timestamp: new Date().toLocaleString('zh-CN')
            };
            
            // 移除相同method和url的旧记录，确保每个API只保留最新的一条记录
            history = history.filter(item => !(item.method === method && item.url === url));
            
            // 添加新记录到最前面
            history.unshift(record);
            
            // 限制历史记录总数
            if (history.length > MAX_HISTORY) {
                history = history.slice(0, MAX_HISTORY);
            }
            
            localStorage.setItem(storageKey, JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const storageKey = 'api_test_history';
            const history = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const historyContainer = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<div class="empty-history">📭 暂无请求历史</div>';
                return;
            }
            
            historyContainer.innerHTML = history.map(record => {
                const statusClass = record.status >= 200 && record.status < 300 ? 'success' : 'error';
                return `
                    <div class="history-item" onclick="loadHistoryItem(${record.id})">
                        <div class="history-item-header">
                            <div>
                                <span class="history-item-method method-${record.method}">${record.method}</span>
                                <span class="history-item-url">${escapeHtml(record.url)}</span>
                            </div>
                            <div class="history-item-actions">
                                <span class="history-item-date">${record.timestamp}</span>
                                <button class="delete-history-btn" onclick="deleteHistoryItem(${record.id}, event)">删除</button>
                            </div>
                        </div>
                        <div class="history-item-status">
                            状态: <span class="${statusClass}">${record.status}</span> | 
                            耗时: ${record.duration}ms
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadHistoryItem(recordId) {
            const storageKey = 'api_test_history';
            const history = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const record = history.find(r => r.id === recordId);
            
            if (!record) return;

            // 设置标志位，防止自动解析URL
            isLoadingHistory = true;

            // 设置方法和URL（使用原始URL，不自动解析）
            document.getElementById('httpMethod').value = record.method;
            document.getElementById('apiUrl').value = record.url;

            // 加载Query Params（包括未选中的）
            document.getElementById('paramsList').innerHTML = '';
            paramsCount = 0;
            if (Array.isArray(record.params) && record.params.length > 0) {
                // 新格式：数组格式，包含enabled状态
                record.params.forEach(param => {
                    addParam();
                    const row = document.querySelector('#paramsList .key-value-row:last-child');
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    const keyInput = row.querySelector('.key-input');
                    const valueInput = row.querySelector('.value-input');
                    if (checkbox) checkbox.checked = param.enabled;
                    if (keyInput) keyInput.value = param.key;
                    if (valueInput) valueInput.value = param.value;
                });
            } else if (record.params && typeof record.params === 'object') {
                // 旧格式：对象格式，兼容处理
                Object.entries(record.params).forEach(([key, value]) => {
                    addParam();
                    const row = document.querySelector('#paramsList .key-value-row:last-child');
                    row.querySelector('.key-input').value = key;
                    row.querySelector('.value-input').value = value;
                });
            } else {
                addParam();
            }

            // 加载Path Variables（包括未选中的）
            document.getElementById('pathVarsList').innerHTML = '';
            pathVarsCount = 0;
            if (Array.isArray(record.pathVars) && record.pathVars.length > 0) {
                record.pathVars.forEach(pathVar => {
                    addPathVar(pathVar.key, pathVar.value);
                    const row = document.querySelector('#pathVarsList .key-value-row:last-child');
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = pathVar.enabled;
                });
            } else if (record.pathVars && typeof record.pathVars === 'object') {
                // 旧格式兼容
                Object.entries(record.pathVars).forEach(([key, value]) => {
                    addPathVar(key, value);
                });
            }

            // 加载Headers（包括未选中的）
            document.getElementById('headersList').innerHTML = '';
            headersCount = 0;
            if (Array.isArray(record.headers) && record.headers.length > 0) {
                record.headers.forEach(header => {
                    addHeader();
                    const row = document.querySelector('#headersList .key-value-row:last-child');
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    const keyInput = row.querySelector('.key-input');
                    const valueInput = row.querySelector('.value-input');
                    if (checkbox) checkbox.checked = header.enabled;
                    if (keyInput) keyInput.value = header.key;
                    if (valueInput) valueInput.value = header.value;
                });
            } else if (record.headers && typeof record.headers === 'object') {
                // 旧格式兼容
                Object.entries(record.headers).forEach(([key, value]) => {
                    addHeader();
                    const row = document.querySelector('#headersList .key-value-row:last-child');
                    row.querySelector('.key-input').value = key;
                    row.querySelector('.value-input').value = value;
                });
            } else {
                addHeader();
            }

            // 加载认证信息
            if (record.authData) {
                document.getElementById('authType').value = record.authData.type || 'none';
                document.getElementById('bearerToken').value = record.authData.bearerToken || '';
                document.getElementById('basicUsername').value = record.authData.basicUsername || '';
                document.getElementById('basicPassword').value = record.authData.basicPassword || '';
                document.getElementById('apiKeyName').value = record.authData.apiKeyName || 'X-API-Key';
                document.getElementById('apiKeyValue').value = record.authData.apiKeyValue || '';
                document.getElementById('apiKeyLocation').value = record.authData.apiKeyLocation || 'header';
                document.getElementById('oauth2Token').value = record.authData.oauth2Token || '';
                document.getElementById('oauth2TokenType').value = record.authData.oauth2TokenType || 'Bearer';
                switchAuthType();
            }

            // 加载Body数据
            if (record.bodyData) {
                currentBodyType = record.bodyData.type || 'none';
                document.getElementById('jsonBody').value = record.bodyData.jsonBody || '';
                document.getElementById('textBody').value = record.bodyData.textBody || '';
                
                // 切换到对应的body类型
                document.querySelectorAll('.body-type-option').forEach(opt => opt.classList.remove('active'));
                const bodyTypeMap = {
                    'none': 0,
                    'json': 1,
                    'form': 2,
                    'text': 3,
                    'protobuf': 4
                };
                const bodyTypeOptions = document.querySelectorAll('.body-type-option');
                if (bodyTypeOptions[bodyTypeMap[currentBodyType]]) {
                    bodyTypeOptions[bodyTypeMap[currentBodyType]].classList.add('active');
                }
                
                // 显示对应的body内容
                document.querySelectorAll('.body-content').forEach(content => {
                    content.style.display = 'none';
                });
                const bodyContentMap = {
                    'none': 'bodyNone',
                    'json': 'bodyJson',
                    'form': 'bodyForm',
                    'text': 'bodyText',
                    'protobuf': 'bodyProtobuf'
                };
                const bodyContent = document.getElementById(bodyContentMap[currentBodyType]);
                if (bodyContent) {
                    bodyContent.style.display = 'block';
                }
                
                // 加载Form Data
                if (currentBodyType === 'form' && Array.isArray(record.bodyData.formData)) {
                    document.getElementById('formDataList').innerHTML = '';
                    formDataCount = 0;
                    record.bodyData.formData.forEach(formItem => {
                        addFormData();
                        const row = document.querySelector('#formDataList .key-value-row:last-child');
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        const keyInput = row.querySelector('.key-input');
                        const valueInput = row.querySelector('.value-input');
                        if (checkbox) checkbox.checked = formItem.enabled;
                        if (keyInput) keyInput.value = formItem.key;
                        if (valueInput) valueInput.value = formItem.value;
                    });
                }
                
                // 加载 Protobuf Data
                if (currentBodyType === 'protobuf' && record.bodyData.protobufData) {
                    const protobufData = record.bodyData.protobufData;
                    if (protobufData.protoDefinition) {
                        document.getElementById('requestProtoDefinition').value = protobufData.protoDefinition;
                        // 解析 Proto
                        setTimeout(() => {
                            parseRequestProto(true);
                            // 设置选中的消息类型
                            if (protobufData.messageType) {
                                document.getElementById('requestProtoMessageType').value = protobufData.messageType;
                                requestProtoCurrentMessageType = protobufData.messageType;
                            }
                            // 设置 JSON 输入
                            if (protobufData.jsonInput) {
                                document.getElementById('protobufJsonInput').value = protobufData.jsonInput;
                                generateProtobufPreview();
                            }
                        }, 200);
                    }
                }
            }

            // 加载并显示响应数据（如果有）
            if (record.responseBody !== undefined && record.responseHeaders !== undefined) {
                // 处理Protobuf数据，将数组转换回Uint8Array
                let responseBody = record.responseBody;
                if (responseBody && responseBody.__isProtobuf && Array.isArray(responseBody.data)) {
                    responseBody = {
                        __isProtobuf: true,
                        data: new Uint8Array(responseBody.data)
                    };
                }
                
                // 显示响应结果
                displayResponse(record.status, record.duration, responseBody, record.responseHeaders, record.contentType, record.requestHeaders || {});
            }

            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // 重置标志位，恢复自动解析功能
            setTimeout(() => {
                isLoadingHistory = false;
            }, 100);
        }

        function deleteHistoryItem(recordId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (confirm('确定要删除这条历史记录吗？')) {
                const storageKey = 'api_test_history';
                let history = JSON.parse(localStorage.getItem(storageKey) || '[]');
                history = history.filter(r => r.id !== recordId);
                localStorage.setItem(storageKey, JSON.stringify(history));
                loadHistory();
            }
        }

        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                const storageKey = 'api_test_history';
                localStorage.removeItem(storageKey);
                loadHistory();
            }
        }

        // ==================== 配置导出导入功能 ====================
        
        // 导出配置
        function exportConfiguration() {
            try {
                // 收集所有配置数据
                const configuration = {
                    version: '1.0.0',
                    exportTime: new Date().toISOString(),
                    exportTimeReadable: new Date().toLocaleString('zh-CN'),
                    data: {
                        // 环境配置
                        environments: JSON.parse(localStorage.getItem('api_environments') || '{}'),
                        currentEnvironment: localStorage.getItem('api_current_environment') || 'default',
                        
                        // 历史记录
                        history: JSON.parse(localStorage.getItem('api_test_history') || '[]'),
                        
                        // Authorization配置
                        authorization: JSON.parse(localStorage.getItem('api_test_authorization') || '{}')
                    }
                };
                
                // 生成文件名
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `api-test-config-${timestamp}.json`;
                
                // 创建Blob并下载
                const blob = new Blob([JSON.stringify(configuration, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // 显示成功提示
                const historyCount = configuration.data.history.length;
                const envCount = Object.keys(configuration.data.environments).length;
                alert(`✅ 配置导出成功！\n\n包含：\n- ${envCount} 个环境配置\n- ${historyCount} 条历史记录\n- Authorization配置\n\n文件名：${filename}`);
                
            } catch (error) {
                console.error('导出配置失败:', error);
                alert('❌ 导出配置失败：' + error.message);
            }
        }
        
        // 触发文件选择
        function importConfiguration() {
            document.getElementById('configFileInput').click();
        }
        
        // 处理文件选择
        function handleConfigFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 验证文件类型
            if (!file.name.endsWith('.json')) {
                alert('❌ 请选择有效的 JSON 配置文件');
                event.target.value = ''; // 清空选择
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const configuration = JSON.parse(e.target.result);
                    
                    // 验证配置格式
                    if (!configuration.version || !configuration.data) {
                        throw new Error('配置文件格式无效');
                    }
                    
                    // 显示导入确认
                    const historyCount = configuration.data.history?.length || 0;
                    const envCount = Object.keys(configuration.data.environments || {}).length;
                    const exportTime = configuration.exportTimeReadable || configuration.exportTime;
                    
                    const confirmMessage = `确定要导入此配置吗？\n\n配置信息：\n- 导出时间：${exportTime}\n- 环境数量：${envCount} 个\n- 历史记录：${historyCount} 条\n\n⚠️ 注意：导入将会：\n1. 合并环境配置（同名环境将被覆盖）\n2. 合并历史记录（相同URL的请求将保留最新的）\n3. 覆盖Authorization配置`;
                    
                    if (!confirm(confirmMessage)) {
                        event.target.value = ''; // 清空选择
                        return;
                    }
                    
                    // 执行导入
                    performImport(configuration);
                    
                } catch (error) {
                    console.error('导入配置失败:', error);
                    alert('❌ 导入配置失败：' + error.message);
                }
                
                // 清空文件选择，允许重复导入同一文件
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert('❌ 读取文件失败');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // 执行导入操作
        function performImport(configuration) {
            try {
                let importedCount = 0;
                
                // 1. 导入环境配置（合并）
                if (configuration.data.environments) {
                    const existingEnvs = JSON.parse(localStorage.getItem('api_environments') || '{}');
                    const mergedEnvs = { ...existingEnvs, ...configuration.data.environments };
                    localStorage.setItem('api_environments', JSON.stringify(mergedEnvs));
                    importedCount++;
                }
                
                // 2. 导入历史记录（合并，去重）
                if (configuration.data.history) {
                    const existingHistory = JSON.parse(localStorage.getItem('api_test_history') || '[]');
                    const importedHistory = configuration.data.history;
                    
                    // 创建URL+Method的映射，用于去重
                    const historyMap = new Map();
                    
                    // 先添加现有记录
                    existingHistory.forEach(record => {
                        const key = `${record.method}|${record.url}`;
                        historyMap.set(key, record);
                    });
                    
                    // 再添加导入的记录（会覆盖同URL的旧记录）
                    importedHistory.forEach(record => {
                        const key = `${record.method}|${record.url}`;
                        // 如果导入的记录更新，则使用导入的；否则保留现有的
                        if (!historyMap.has(key) || new Date(record.timestamp) > new Date(historyMap.get(key).timestamp)) {
                            historyMap.set(key, record);
                        }
                    });
                    
                    // 转换回数组，按时间戳排序
                    const mergedHistory = Array.from(historyMap.values())
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        .slice(0, MAX_HISTORY); // 限制最大数量
                    
                    localStorage.setItem('api_test_history', JSON.stringify(mergedHistory));
                    importedCount++;
                }
                
                // 3. 导入Authorization配置（覆盖）
                if (configuration.data.authorization && Object.keys(configuration.data.authorization).length > 0) {
                    localStorage.setItem('api_test_authorization', JSON.stringify(configuration.data.authorization));
                    importedCount++;
                }
                
                // 4. 如果导入了环境配置，更新当前环境
                if (configuration.data.currentEnvironment && configuration.data.environments[configuration.data.currentEnvironment]) {
                    localStorage.setItem('api_current_environment', configuration.data.currentEnvironment);
                }
                
                // 重新加载所有配置
                loadGlobalVariables();
                loadAuthorizationConfig();
                loadHistory();
                
                // 显示成功提示
                const historyCount = configuration.data.history?.length || 0;
                const envCount = Object.keys(configuration.data.environments || {}).length;
                alert(`✅ 配置导入成功！\n\n已导入：\n- ${envCount} 个环境配置\n- ${historyCount} 条历史记录\n- Authorization配置\n\n页面配置已自动刷新。`);
                
            } catch (error) {
                console.error('执行导入失败:', error);
                alert('❌ 导入过程中出现错误：' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== Protobuf 相关函数 ====================
        
        // 切换Protobuf配置区域
        function toggleProtobufConfig() {
            const content = document.getElementById('protobufConfigContent');
            const icon = document.getElementById('protobufToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // 解析Proto定义
        function parseProtoDefinition() {
            const protoContent = document.getElementById('protoDefinition').value.trim();
            
            if (!protoContent) {
                showProtobufStatus('请输入 Proto 定义', 'error');
                return;
            }

            try {
                // 检查protobuf库是否加载
                if (typeof protobuf === 'undefined') {
                    showProtobufStatus('Protobuf库未加载，请刷新页面重试', 'error');
                    return;
                }

                // 使用 protobuf.js 解析 proto 内容
                protobufRoot = protobuf.parse(protoContent).root;
                
                // 获取所有消息类型
                const messageTypes = [];
                function findMessageTypes(namespace, prefix = '') {
                    if (namespace.nested) {
                        for (const [name, nested] of Object.entries(namespace.nested)) {
                            const fullName = prefix ? `${prefix}.${name}` : name;
                            if (nested instanceof protobuf.Type) {
                                messageTypes.push(fullName);
                            }
                            if (nested.nested) {
                                findMessageTypes(nested, fullName);
                            }
                        }
                    }
                }
                findMessageTypes(protobufRoot);

                if (messageTypes.length === 0) {
                    showProtobufStatus('未找到任何消息类型定义', 'error');
                    return;
                }

                // 填充消息类型下拉框
                const selectElement = document.getElementById('protobufMessageTypeSelect');
                selectElement.innerHTML = messageTypes.map(type => 
                    `<option value="${type}">${type}</option>`
                ).join('');
                
                document.getElementById('protobufMessageTypeGroup').style.display = 'block';
                protobufMessageType = messageTypes[0];
                
                // 保存到localStorage
                try {
                    localStorage.setItem('protobuf_definition', protoContent);
                    localStorage.setItem('protobuf_message_types', JSON.stringify(messageTypes));
                    localStorage.setItem('protobuf_current_type', protobufMessageType);
                } catch (e) {
                    console.warn('保存Proto定义到localStorage失败:', e);
                }
                
                showProtobufStatus(`✅ 解析成功！找到 ${messageTypes.length} 个消息类型`, 'success');
                
            } catch (error) {
                showProtobufStatus('解析失败: ' + error.message, 'error');
                console.error('Proto解析错误:', error);
            }
        }

        // 清空Proto定义
        function clearProtoDefinition() {
            document.getElementById('protoDefinition').value = '';
            document.getElementById('protobufMessageTypeGroup').style.display = 'none';
            protobufRoot = null;
            protobufMessageType = null;
            
            // 清除localStorage
            try {
                localStorage.removeItem('protobuf_definition');
                localStorage.removeItem('protobuf_message_types');
                localStorage.removeItem('protobuf_current_type');
            } catch (e) {
                console.warn('清除localStorage失败:', e);
            }
            
            showProtobufStatus('已清空 Proto 定义', 'success');
        }

        // 显示Protobuf状态消息
        function showProtobufStatus(message, type) {
            const statusElement = document.getElementById('protobufStatus');
            statusElement.textContent = message;
            statusElement.style.display = 'inline-block';
            
            if (type === 'success') {
                statusElement.style.background = '#d4edda';
                statusElement.style.color = '#155724';
                statusElement.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusElement.style.background = '#f8d7da';
                statusElement.style.color = '#721c24';
                statusElement.style.border = '1px solid #f5c6cb';
            }
            
            // 3秒后自动隐藏
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // 监听消息类型选择变化
        document.addEventListener('DOMContentLoaded', function() {
            const messageTypeSelect = document.getElementById('protobufMessageTypeSelect');
            if (messageTypeSelect) {
                messageTypeSelect.addEventListener('change', function() {
                    protobufMessageType = this.value;
                    // 保存到localStorage
                    try {
                        localStorage.setItem('protobuf_current_type', protobufMessageType);
                    } catch (e) {
                        console.warn('保存当前消息类型失败:', e);
                    }
                });
            }
            
            // 尝试从localStorage恢复Proto定义
            try {
                const savedProto = localStorage.getItem('protobuf_definition');
                const savedTypes = localStorage.getItem('protobuf_message_types');
                const savedCurrentType = localStorage.getItem('protobuf_current_type');
                
                if (savedProto) {
                    document.getElementById('protoDefinition').value = savedProto;
                    
                    if (savedTypes) {
                        const messageTypes = JSON.parse(savedTypes);
                        
                        // 尝试重新解析
                        try {
                            protobufRoot = protobuf.parse(savedProto).root;
                            
                            const selectElement = document.getElementById('protobufMessageTypeSelect');
                            selectElement.innerHTML = messageTypes.map(type => 
                                `<option value="${type}" ${type === savedCurrentType ? 'selected' : ''}>${type}</option>`
                            ).join('');
                            
                            document.getElementById('protobufMessageTypeGroup').style.display = 'block';
                            protobufMessageType = savedCurrentType || messageTypes[0];
                            
                            console.log('已从缓存恢复 Proto 定义');
                        } catch (e) {
                            console.warn('恢复Proto定义失败:', e);
                        }
                    }
                }
            } catch (e) {
                console.warn('从localStorage加载Proto定义失败:', e);
            }
        });

        // ==================== Protobuf 请求 Body 相关功能 ====================
        let requestProtoRoot = null;
        let requestProtoCurrentMessageType = null;
        const REQUEST_PROTO_CACHE_KEY = 'api_tool_request_protobuf_cache';

        // 保存请求 Proto 到缓存
        function saveRequestProtoToCache(protoContent, messageTypes) {
            try {
                const cacheData = {
                    protoContent: protoContent,
                    messageTypes: messageTypes,
                    timestamp: new Date().toISOString(),
                    currentMessageType: messageTypes[0] || null
                };
                localStorage.setItem(REQUEST_PROTO_CACHE_KEY, JSON.stringify(cacheData));
            } catch (error) {
                console.warn('请求Proto缓存保存失败:', error);
            }
        }

        // 从缓存加载请求 Proto
        function loadRequestProtoFromCache() {
            try {
                const cacheStr = localStorage.getItem(REQUEST_PROTO_CACHE_KEY);
                if (!cacheStr) return null;
                return JSON.parse(cacheStr);
            } catch (error) {
                console.warn('请求Proto缓存加载失败:', error);
                return null;
            }
        }

        // 显示请求 Proto 缓存状态
        function showRequestProtoCacheStatus() {
            const cache = loadRequestProtoFromCache();
            const statusElement = document.getElementById('requestProtoCacheStatus');
            const statusText = document.getElementById('requestProtoCacheStatusText');
            
            if (cache && cache.protoContent) {
                const cacheDate = new Date(cache.timestamp);
                const now = new Date();
                const diffMinutes = Math.floor((now - cacheDate) / (1000 * 60));
                
                let timeText = '';
                if (diffMinutes < 1) {
                    timeText = '刚刚';
                } else if (diffMinutes < 60) {
                    timeText = diffMinutes + '分钟前';
                } else if (diffMinutes < 1440) {
                    timeText = Math.floor(diffMinutes / 60) + '小时前';
                } else {
                    timeText = Math.floor(diffMinutes / 1440) + '天前';
                }
                
                statusText.textContent = `已检测到缓存的 Proto 定义（${timeText}），包含 ${cache.messageTypes.length} 个消息类型`;
                statusElement.style.display = 'block';
            } else {
                statusElement.style.display = 'none';
            }
        }

        // 解析请求 Proto
        function parseRequestProto(fromCache = false) {
            const protoContent = document.getElementById('requestProtoDefinition').value.trim();
            
            if (!protoContent) {
                alert('❌ 请输入 Proto 文件内容');
                return;
            }

            try {
                // 使用 protobuf.js 解析 proto 内容
                requestProtoRoot = protobuf.parse(protoContent).root;
                
                // 获取所有消息类型
                const messageTypes = [];
                function findMessageTypes(namespace, prefix = '') {
                    if (namespace.nested) {
                        for (const [name, nested] of Object.entries(namespace.nested)) {
                            const fullName = prefix ? `${prefix}.${name}` : name;
                            if (nested instanceof protobuf.Type) {
                                messageTypes.push(fullName);
                            }
                            if (nested.nested) {
                                findMessageTypes(nested, fullName);
                            }
                        }
                    }
                }
                findMessageTypes(requestProtoRoot);

                if (messageTypes.length === 0) {
                    alert('❌ 未找到任何消息类型定义');
                    return;
                }

                // 填充消息类型下拉框
                const selectElement = document.getElementById('requestProtoMessageType');
                selectElement.innerHTML = messageTypes.map(type => 
                    `<option value="${type}">${type}</option>`
                ).join('');
                
                document.getElementById('requestProtoMessageTypeGroup').style.display = 'block';
                requestProtoCurrentMessageType = messageTypes[0];
                
                // 保存到缓存
                saveRequestProtoToCache(protoContent, messageTypes);
                
                // 解析成功后隐藏缓存状态提示
                if (!fromCache) {
                    document.getElementById('requestProtoCacheStatus').style.display = 'none';
                    alert(`✅ Proto 文件解析成功！找到 ${messageTypes.length} 个消息类型`);
                }
                
                // 监听 JSON 输入变化，自动生成预览
                document.getElementById('protobufJsonInput').addEventListener('input', generateProtobufPreview);
                
                // 立即生成一次预览
                generateProtobufPreview();
                
            } catch (error) {
                alert('❌ Proto 解析失败: ' + error.message);
                console.error(error);
            }
        }

        // 清空请求 Proto
        function clearRequestProto() {
            document.getElementById('requestProtoDefinition').value = '';
            document.getElementById('requestProtoMessageTypeGroup').style.display = 'none';
            document.getElementById('protobufEncodedPreview').style.display = 'none';
            
            requestProtoRoot = null;
            requestProtoCurrentMessageType = null;
            
            // 清除缓存
            localStorage.removeItem(REQUEST_PROTO_CACHE_KEY);
            
            // 隐藏缓存状态
            document.getElementById('requestProtoCacheStatus').style.display = 'none';
            
            alert('✅ 已清空（包括缓存）');
        }

        // 监听请求消息类型选择变化
        document.getElementById('requestProtoMessageType')?.addEventListener('change', function() {
            requestProtoCurrentMessageType = this.value;
            generateProtobufPreview();
        });

        // 生成 Protobuf 编码预览
        function generateProtobufPreview() {
            if (!requestProtoRoot || !requestProtoCurrentMessageType) {
                return;
            }

            const jsonInput = document.getElementById('protobufJsonInput')?.value.trim();
            if (!jsonInput) {
                document.getElementById('protobufEncodedPreview').style.display = 'none';
                return;
            }

            try {
                const selectedType = document.getElementById('requestProtoMessageType').value;
                const MessageType = requestProtoRoot.lookupType(selectedType);
                const jsonData = JSON.parse(jsonInput);
                
                // 验证消息
                const errMsg = MessageType.verify(jsonData);
                if (errMsg) {
                    throw new Error(errMsg);
                }
                
                // 创建消息
                const message = MessageType.create(jsonData);
                
                // 编码为二进制
                const buffer = MessageType.encode(message).finish();
                
                // 转为 Hex 显示
                const hex = Array.from(buffer)
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(' ');
                
                document.getElementById('protobufEncodedHex').textContent = hex + `\n\n字节数: ${buffer.length}`;
                document.getElementById('protobufEncodedPreview').style.display = 'block';
                
            } catch (error) {
                document.getElementById('protobufEncodedHex').textContent = '❌ 编码失败: ' + error.message;
                document.getElementById('protobufEncodedPreview').style.display = 'block';
            }
        }

        // 编码 Protobuf 请求
        async function encodeProtobufRequest() {
            if (!requestProtoRoot || !requestProtoCurrentMessageType) {
                alert('❌ 请先解析 Proto 文件');
                return null;
            }

            const jsonInput = document.getElementById('protobufJsonInput')?.value.trim();
            if (!jsonInput) {
                alert('❌ 请输入 JSON 数据');
                return null;
            }

            try {
                const selectedType = document.getElementById('requestProtoMessageType').value;
                const MessageType = requestProtoRoot.lookupType(selectedType);
                const jsonData = JSON.parse(jsonInput);
                
                // 验证消息
                const errMsg = MessageType.verify(jsonData);
                if (errMsg) {
                    throw new Error(errMsg);
                }
                
                // 创建消息
                const message = MessageType.create(jsonData);
                
                // 编码为二进制
                const buffer = MessageType.encode(message).finish();
                
                // 返回 ArrayBuffer
                return buffer.buffer;
                
            } catch (error) {
                console.error('Protobuf 编码失败:', error);
                alert('❌ Protobuf 编码失败: ' + error.message);
                return null;
            }
        }

        // 页面加载时尝试从缓存恢复请求 Proto
        window.addEventListener('DOMContentLoaded', function() {
            const cache = loadRequestProtoFromCache();
            if (cache && cache.protoContent) {
                document.getElementById('requestProtoDefinition').value = cache.protoContent;
                
                // 显示缓存状态
                showRequestProtoCacheStatus();
                
                // 自动解析缓存的proto
                setTimeout(() => {
                    parseRequestProto(true);
                }, 100);
            }
        });
    </script>
    
    <!-- Protobuf.js 库 -->
    <script src="libs/protobuf.min.js"></script>
</body>
</html>


